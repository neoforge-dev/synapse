============================= test session starts ==============================
platform darwin -- Python 3.12.7, pytest-8.3.5, pluggy-1.5.0 -- /Users/bogdan/til/graph-rag-mcp/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/bogdan/til/graph-rag-mcp/tests
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-0.26.0, mock-3.14.0, cov-6.1.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 23 items

tests/integration/test_e2e.py::test_ingest_and_keyword_search 
-------------------------------- live log setup --------------------------------
2025-04-16 19:35:51 [    INFO] spaCy model 'en_core_web_sm' already available. (conftest.py:65)
2025-04-16 19:35:51 [    INFO] [Fixture] Clearing database: bolt://localhost:7687 before test. (test_e2e.py:93)
2025-04-16 19:35:51 [    INFO] [Fixture] Database cleared. (test_e2e.py:95)
-------------------------------- live log call ---------------------------------
2025-04-16 19:35:51 [    INFO] rid=727e7cf4-46e3-4e79-8d48-1c545940cd9a path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:35:51 [    INFO] Creating DocumentProcessor instance (SimpleDocumentProcessor) (dependencies.py:120)
2025-04-16 19:35:51 [    INFO] Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200 (document_processor.py:104)
2025-04-16 19:35:51 [    INFO] Creating EntityExtractor instance of type: spacy (dependencies.py:130)
2025-04-16 19:35:51 [    INFO] spaCy model 'en_core_web_sm' loaded successfully. (entity_extractor.py:74)
2025-04-16 19:35:51 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
2025-04-16 19:35:51 [    INFO] Loading sentence-transformer model: all-MiniLM-L6-v2 (simple_vector_store.py:18)
2025-04-16 19:35:51 [    INFO] Use pytorch device_name: mps (SentenceTransformer.py:211)
2025-04-16 19:35:51 [    INFO] Load pretrained SentenceTransformer: all-MiniLM-L6-v2 (SentenceTransformer.py:219)
2025-04-16 19:35:53 [    INFO] Sentence-transformer model loaded successfully. (simple_vector_store.py:20)
2025-04-16 19:35:53 [    INFO] Creating EmbeddingService instance (SentenceTransformerEmbeddingService) (dependencies.py:226)
2025-04-16 19:35:53 [    INFO] Loading embedding model: all-MiniLM-L6-v2 (embedding.py:27)
2025-04-16 19:35:53 [    INFO] Use pytorch device_name: mps (SentenceTransformer.py:211)
2025-04-16 19:35:53 [    INFO] Load pretrained SentenceTransformer: all-MiniLM-L6-v2 (SentenceTransformer.py:219)
2025-04-16 19:35:55 [    INFO] Embedding model loaded successfully. (embedding.py:31)
2025-04-16 19:35:55 [ WARNING] Ingestion service not found in app state, creating new instance. (dependencies.py:311)
2025-04-16 19:35:55 [    INFO] IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository (ingestion.py:53)
2025-04-16 19:35:55 [    INFO] [Req ID: 354555ce-9f7a-423b-b8c0-98ba97f4df6e] Received ingestion request. (ingestion.py:62)
2025-04-16 19:35:55 [    INFO] Starting ingestion for document with metadata: {'source': 'integration_test', 'color': 'blue'} (ingestion.py:77)
2025-04-16 19:35:55 [    INFO] Successfully added/updated node 625534e3-38ec-4620-9dec-993c724fc810 with type Document (memgraph_store.py:360)
2025-04-16 19:35:55 [    INFO] Saved document with ID: None (ingestion.py:86)
2025-04-16 19:35:55 [    INFO] Split document 625534e3-38ec-4620-9dec-993c724fc810 into 1 sentence chunks. (document_processor.py:86)
2025-04-16 19:35:55 [    INFO] Document 625534e3-38ec-4620-9dec-993c724fc810 split into 1 chunks. (ingestion.py:163)
2025-04-16 19:35:55 [    INFO] Split document None into 1 chunks. (ingestion.py:93)
2025-04-16 19:35:55 [   ERROR] Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content' (ingestion.py:115)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
2025-04-16 19:35:55 [   ERROR] Failed to save chunk 21e77928-7944-4952-ad46-478c4974538a or its relationship for document None: 'Chunk' object has no attribute 'type' (ingestion.py:147)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:35:55 [    INFO] Ingestion complete for document None. Saved 0 chunks. (ingestion.py:151)
2025-04-16 19:35:55 [   ERROR] Background processing failed for document doc-a4e765d2-85df-4dd1-b0f1-792ce67444fb: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type (ingestion.py:35)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:35:55 [    INFO] HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:35:55 [    INFO] Waiting 5 seconds for ingestion to process... (test_e2e.py:143)
2025-04-16 19:36:10 [    INFO] rid=cb1a9bee-30ea-42f7-bd92-67df189df4cb path=/api/v1/search/query method=POST (main.py:315)
2025-04-16 19:36:10 [ WARNING] LLM_TYPE not found in settings. Falling back to MockLLMService. (dependencies.py:101)
2025-04-16 19:36:10 [   ERROR] Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined (main.py:323)
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
FAILED                                                                   [  4%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:11 [    INFO] [Fixture] Closed DB connection after test. (test_e2e.py:106)

tests/integration/test_e2e.py::test_ingest_and_vector_search 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:11 [    INFO] [Fixture] Clearing database: bolt://localhost:7687 before test. (test_e2e.py:93)
2025-04-16 19:36:11 [    INFO] [Fixture] Database cleared. (test_e2e.py:95)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:11 [    INFO] rid=b4bdd9a2-a461-4ae3-9dc4-df11a94dbc93 path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:11 [ WARNING] Ingestion service not found in app state, creating new instance. (dependencies.py:311)
2025-04-16 19:36:11 [    INFO] IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository (ingestion.py:53)
2025-04-16 19:36:11 [    INFO] [Req ID: 70bc8575-b04e-45f5-9d50-4549466367a1] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:11 [    INFO] Starting ingestion for document with metadata: {'source': 'integration_test', 'topic': 'search'} (ingestion.py:77)
2025-04-16 19:36:11 [    INFO] Successfully added/updated node a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f with type Document (memgraph_store.py:360)
2025-04-16 19:36:11 [    INFO] Saved document with ID: None (ingestion.py:86)
2025-04-16 19:36:11 [    INFO] Split document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f into 1 sentence chunks. (document_processor.py:86)
2025-04-16 19:36:11 [    INFO] Document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f split into 1 chunks. (ingestion.py:163)
2025-04-16 19:36:11 [    INFO] Split document None into 1 chunks. (ingestion.py:93)
2025-04-16 19:36:11 [   ERROR] Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content' (ingestion.py:115)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
2025-04-16 19:36:11 [   ERROR] Failed to save chunk ce433f34-6215-4cbe-b5b4-2571f63a5d36 or its relationship for document None: 'Chunk' object has no attribute 'type' (ingestion.py:147)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:36:11 [    INFO] Ingestion complete for document None. Saved 0 chunks. (ingestion.py:151)
2025-04-16 19:36:11 [   ERROR] Background processing failed for document doc-bebceee6-168c-4ae3-ab9d-d06e0aa2e0c9: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type (ingestion.py:35)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:36:11 [    INFO] HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:11 [    INFO] Waiting 5 seconds for ingestion and embedding to process... (test_e2e.py:185)
2025-04-16 19:36:26 [    INFO] rid=2632745c-339d-410a-9c18-b751d205a03a path=/api/v1/search/query method=POST (main.py:315)
2025-04-16 19:36:26 [ WARNING] LLM_TYPE not found in settings. Falling back to MockLLMService. (dependencies.py:101)
2025-04-16 19:36:26 [   ERROR] Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined (main.py:323)
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
FAILED                                                                   [  8%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:26 [    INFO] [Fixture] Closed DB connection after test. (test_e2e.py:106)

tests/integration/test_e2e.py::test_search_nonexistent_term 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:26 [    INFO] [Fixture] Clearing database: bolt://localhost:7687 before test. (test_e2e.py:93)
2025-04-16 19:36:26 [    INFO] [Fixture] Database cleared. (test_e2e.py:95)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] rid=f3c24b64-8970-4747-ab3c-07bab7d13214 path=/api/v1/search/query method=POST (main.py:315)
2025-04-16 19:36:27 [ WARNING] LLM_TYPE not found in settings. Falling back to MockLLMService. (dependencies.py:101)
2025-04-16 19:36:27 [   ERROR] Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined (main.py:323)
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
FAILED                                                                   [ 13%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] [Fixture] Closed DB connection after test. (test_e2e.py:106)

tests/integration/test_e2e.py::test_ingest_and_delete 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] [Fixture] Clearing database: bolt://localhost:7687 before test. (test_e2e.py:93)
2025-04-16 19:36:27 [    INFO] [Fixture] Database cleared. (test_e2e.py:95)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] rid=28eee7cf-7617-4311-9185-0d7f9d933beb path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:27 [ WARNING] Ingestion service not found in app state, creating new instance. (dependencies.py:311)
2025-04-16 19:36:27 [    INFO] IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository (ingestion.py:53)
2025-04-16 19:36:27 [    INFO] [Req ID: 0f54c7ff-39d4-4a3c-9c33-d96ab5a45cdb] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:27 [    INFO] Starting ingestion for document with metadata: {'source': 'integration_test_delete'} (ingestion.py:77)
2025-04-16 19:36:27 [    INFO] Successfully added/updated node f5ee47f1-5882-4000-8b79-74fdb9d43481 with type Document (memgraph_store.py:360)
2025-04-16 19:36:27 [    INFO] Saved document with ID: None (ingestion.py:86)
2025-04-16 19:36:27 [    INFO] Split document f5ee47f1-5882-4000-8b79-74fdb9d43481 into 1 sentence chunks. (document_processor.py:86)
2025-04-16 19:36:27 [    INFO] Document f5ee47f1-5882-4000-8b79-74fdb9d43481 split into 1 chunks. (ingestion.py:163)
2025-04-16 19:36:27 [    INFO] Split document None into 1 chunks. (ingestion.py:93)
2025-04-16 19:36:27 [   ERROR] Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content' (ingestion.py:115)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
2025-04-16 19:36:27 [   ERROR] Failed to save chunk 73a6b2d5-6925-472a-a1c6-d6eae39896df or its relationship for document None: 'Chunk' object has no attribute 'type' (ingestion.py:147)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:36:27 [    INFO] Ingestion complete for document None. Saved 0 chunks. (ingestion.py:151)
2025-04-16 19:36:27 [   ERROR] Background processing failed for document doc-6935c20e-6606-4b52-8cdc-b83da4108119: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type (ingestion.py:35)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:36:27 [    INFO] HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:27 [    INFO] rid=1998ae4f-3b30-450f-98f0-df207f53691c path=/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 method=DELETE (main.py:315)
2025-04-16 19:36:27 [    INFO] Attempting to delete document doc-6935c20e-6606-4b52-8cdc-b83da4108119 and its chunks. (documents.py:126)
2025-04-16 19:36:27 [ WARNING] Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found, nothing deleted (deleted flag false). (memgraph_store.py:947)
2025-04-16 19:36:27 [ WARNING] Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found for deletion. (documents.py:130)
2025-04-16 19:36:27 [ WARNING] HTTP exception for http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119: 404 - Document with id doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found or could not be deleted. (main.py:328)
2025-04-16 19:36:27 [    INFO] HTTP Request: DELETE http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 "HTTP/1.1 404 Not Found" (_client.py:1740)
FAILED                                                                   [ 17%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] [Fixture] Closed DB connection after test. (test_e2e.py:106)

tests/integration/test_e2e.py::test_delete_nonexistent 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] [Fixture] Clearing database: bolt://localhost:7687 before test. (test_e2e.py:93)
2025-04-16 19:36:27 [    INFO] [Fixture] Database cleared. (test_e2e.py:95)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] rid=3849548d-f45e-4121-968f-6b271f8a4249 path=/api/v1/documents/non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 method=DELETE (main.py:315)
2025-04-16 19:36:27 [    INFO] Attempting to delete document non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 and its chunks. (documents.py:126)
2025-04-16 19:36:27 [ WARNING] Document non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 not found, nothing deleted (deleted flag false). (memgraph_store.py:947)
2025-04-16 19:36:27 [ WARNING] Document non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 not found for deletion. (documents.py:130)
2025-04-16 19:36:27 [ WARNING] HTTP exception for http://localhost:8000/api/v1/documents/non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62: 404 - Document with id non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 not found or could not be deleted. (main.py:328)
2025-04-16 19:36:27 [    INFO] HTTP Request: DELETE http://localhost:8000/api/v1/documents/non-existent-id-3a2bcf41-55e8-498b-8544-dc3acde5af62 "HTTP/1.1 404 Not Found" (_client.py:1740)
PASSED                                                                   [ 21%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] [Fixture] Closed DB connection after test. (test_e2e.py:106)

tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_document_operations 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
2025-04-16 19:36:27 [    INFO] Persistent connection established. (memgraph_store.py:91)
2025-04-16 19:36:27 [    INFO] Database cleaned successfully using persistent connection. (test_graph_store_integration.py:40)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] Successfully added/updated document 32d56cde-3bc2-4138-900b-bfa9d9acef10 (memgraph_store.py:244)
2025-04-16 19:36:27 [    INFO] Successfully added/updated chunk 4eef0542-5e0e-4144-a285-8c7bc5e7551d for document 32d56cde-3bc2-4138-900b-bfa9d9acef10 (memgraph_store.py:321)
PASSED                                                                   [ 26%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] Persistent connection closed. (memgraph_store.py:104)

tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_entity_operations 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
2025-04-16 19:36:27 [    INFO] Persistent connection established. (memgraph_store.py:91)
2025-04-16 19:36:27 [    INFO] Database cleaned successfully using persistent connection. (test_graph_store_integration.py:40)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] Successfully added/updated node entity_1 with type TEST_ENTITY (memgraph_store.py:360)
2025-04-16 19:36:27 [    INFO] Successfully added/updated node entity_2 with type TEST_ENTITY (memgraph_store.py:360)
PASSED                                                                   [ 30%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] Persistent connection closed. (memgraph_store.py:104)

tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_bulk_operations 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
2025-04-16 19:36:27 [    INFO] Persistent connection established. (memgraph_store.py:91)
2025-04-16 19:36:27 [    INFO] Database cleaned successfully using persistent connection. (test_graph_store_integration.py:40)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] Successfully added/updated document doc_1 (memgraph_store.py:244)
2025-04-16 19:36:27 [    INFO] Successfully added/updated document doc_2 (memgraph_store.py:244)
2025-04-16 19:36:27 [    INFO] Successfully added/updated chunk chunk_1 for document doc_1 (memgraph_store.py:321)
2025-04-16 19:36:27 [    INFO] Successfully added/updated chunk chunk_2 for document doc_1 (memgraph_store.py:321)
2025-04-16 19:36:27 [    INFO] Successfully added/updated chunk chunk_3 for document doc_2 (memgraph_store.py:321)
PASSED                                                                   [ 34%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] Persistent connection closed. (memgraph_store.py:104)

tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_error_handling 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
2025-04-16 19:36:27 [    INFO] Persistent connection established. (memgraph_store.py:91)
2025-04-16 19:36:27 [    INFO] Database cleaned successfully using persistent connection. (test_graph_store_integration.py:40)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [ WARNING] Failed to add chunk ab5d098b-53bd-4954-b696-5d80f26bf596: Document nonexistent_doc not found. (memgraph_store.py:323)
2025-04-16 19:36:27 [   ERROR] Failed to add chunk ab5d098b-53bd-4954-b696-5d80f26bf596: Document nonexistent_doc not found, cannot add chunk ab5d098b-53bd-4954-b696-5d80f26bf596. (memgraph_store.py:326)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 324, in add_chunk
    raise ValueError(f"Document {chunk.document_id} not found, cannot add chunk {chunk.id}.")
ValueError: Document nonexistent_doc not found, cannot add chunk ab5d098b-53bd-4954-b696-5d80f26bf596.
PASSED                                                                   [ 39%]
------------------------------ live log teardown -------------------------------
2025-04-16 19:36:27 [    INFO] Persistent connection closed. (memgraph_store.py:104)

tests/integration/test_ingest_command.py::test_process_and_store_document_cli_logic 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:27 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:27 [    INFO] Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200 (document_processor.py:104)
2025-04-16 19:36:28 [    INFO] spaCy model 'en_core_web_sm' loaded successfully. (entity_extractor.py:74)
2025-04-16 19:36:28 [   ERROR] Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document' (ingest.py:119)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/cli/commands/ingest.py", line 76, in process_and_store_document
    chunks = await doc_processor.process_document(content)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'
FAILED                                                                   [ 43%]
tests/integration/test_ingest_command.py::test_ingest_single_file_success 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
PASSED                                                                   [ 47%]
tests/integration/test_ingest_command.py::test_ingest_directory_success 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
PASSED                                                                   [ 52%]
tests/integration/test_ingest_command.py::test_ingest_file_not_found 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
PASSED                                                                   [ 56%]
tests/integration/test_ingest_command.py::test_ingest_processing_error 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
PASSED                                                                   [ 60%]
tests/integration/test_ingest_command.py::test_ingest_repository_error 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
PASSED                                                                   [ 65%]
tests/integration/test_ingestion_integration.py::test_document_ingestion_pipeline 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:28 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:28 [    INFO] rid=004a45c3-b710-4324-9793-efae251871bd path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:28 [    INFO] [Req ID: c7be4b0d-a528-4e44-bde0-b5738ab63b7d] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:28 [    INFO] Document doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd processed successfully. (ingestion.py:33)
2025-04-16 19:36:28 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:28 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:29 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:30 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:31 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:32 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:33 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:34 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:35 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:36 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
2025-04-16 19:36:37 [ WARNING] Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd (memgraph_store.py:289)
FAILED                                                                   [ 69%]
tests/integration/test_ingestion_integration.py::test_concurrent_ingestion_integration 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:38 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:38 [    INFO] rid=64f11c87-3417-40a0-9a4b-5d3b0896e37e path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:38 [    INFO] rid=cb91bc46-a528-45b9-9f17-43d469a15f03 path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:38 [    INFO] rid=aff056f2-0800-434c-83ca-c85794711547 path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:38 [    INFO] [Req ID: ba8b6207-1a75-4d89-93e4-afd4bbbb337b] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:38 [    INFO] [Req ID: dd3b119f-2881-4c28-85cd-5acc890e47ce] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:38 [    INFO] [Req ID: 82d62035-c03a-4425-8de2-0b80b61455aa] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:38 [    INFO] Document doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 processed successfully. (ingestion.py:33)
2025-04-16 19:36:38 [    INFO] Document doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb processed successfully. (ingestion.py:33)
2025-04-16 19:36:38 [    INFO] Document doc-02e69f36-9a40-454d-b2b1-e63dc0361634 processed successfully. (ingestion.py:33)
2025-04-16 19:36:38 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:38 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:38 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:38 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:38 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:38 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:39 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:39 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:39 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:40 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:40 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:40 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:41 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:41 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:41 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:42 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:42 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:42 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:43 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:43 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:43 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:44 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:44 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:44 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:45 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:45 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:45 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:46 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:46 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:46 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
2025-04-16 19:36:47 [ WARNING] Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 (memgraph_store.py:289)
2025-04-16 19:36:47 [ WARNING] Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb (memgraph_store.py:289)
2025-04-16 19:36:47 [ WARNING] Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634 (memgraph_store.py:289)
FAILED                                                                   [ 73%]
tests/integration/test_ingestion_integration.py::test_large_document_ingestion_integration 
-------------------------------- live log setup --------------------------------
2025-04-16 19:36:48 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
-------------------------------- live log call ---------------------------------
2025-04-16 19:36:48 [    INFO] rid=985a0129-36fb-4a89-b701-7e6aed1ae544 path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:36:48 [    INFO] [Req ID: 1bafa9ca-a77f-4bfc-9f40-e01ca14b7cdc] Received ingestion request. (ingestion.py:62)
2025-04-16 19:36:48 [    INFO] Document doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 processed successfully. (ingestion.py:33)
2025-04-16 19:36:48 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:36:48 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:49 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:50 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:51 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:52 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:53 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:54 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:55 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:56 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:57 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:58 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:36:59 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:37:00 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:37:01 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
2025-04-16 19:37:02 [ WARNING] Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 (memgraph_store.py:289)
FAILED                                                                   [ 78%]
tests/integration/test_ingestion_integration.py::test_error_handling_integration 
-------------------------------- live log setup --------------------------------
2025-04-16 19:37:03 [    INFO] MemgraphGraphRepository initialized for localhost:7687 (memgraph_store.py:81)
-------------------------------- live log call ---------------------------------
2025-04-16 19:37:03 [    INFO] rid=08009218-7e35-437b-be83-8e66bb7fc9cc path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:37:03 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
FAILED                                                                   [ 82%]
tests/integration/test_query_pipeline.py::test_query_pipeline ERROR      [ 86%]
tests/integration/test_query_pipeline.py::test_basic_query 
-------------------------------- live log call ---------------------------------
2025-04-16 19:37:03 [    INFO] rid=eb395961-c9f4-4a72-a206-68f2e355c8f5 path=/api/v1/ingestion/documents method=POST (main.py:315)
2025-04-16 19:37:03 [    INFO] [Req ID: 7a058ac9-5941-4406-8623-875c38b20cfb] Received ingestion request. (ingestion.py:62)
2025-04-16 19:37:03 [    INFO] Document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 processed successfully. (ingestion.py:33)
2025-04-16 19:37:03 [    INFO] HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted" (_client.py:1740)
2025-04-16 19:37:03 [    INFO] Ingested document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 for query test. (test_query_pipeline.py:150)
2025-04-16 19:37:03 [    INFO] rid=0f4287f7-a357-478b-88c9-3e9796383ee9 path=/api/v1/query method=POST (main.py:315)
2025-04-16 19:37:03 [    INFO] Received query: Where is the Eiffel Tower?... (k=5) (query.py:29)
2025-04-16 19:37:03 [    INFO] Query successful. Found 0 chunks. (query.py:33)
2025-04-16 19:37:03 [   ERROR] Error processing query 'Where is the Eiffel Tower?': not enough values to unpack (expected 2, got 0) (query.py:64)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03 [ WARNING] HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0) (main.py:328)
2025-04-16 19:37:03 [    INFO] HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error" (_client.py:1740)
FAILED                                                                   [ 91%]
tests/integration/test_query_pipeline.py::test_query_no_entities 
-------------------------------- live log call ---------------------------------
2025-04-16 19:37:03 [    INFO] rid=e4110218-bacf-48c4-96bc-5ddc2bb6e1cc path=/api/v1/query method=POST (main.py:315)
2025-04-16 19:37:03 [    INFO] Received query: This is a query with no named entities... (k=5) (query.py:29)
2025-04-16 19:37:03 [    INFO] Query successful. Found 0 chunks. (query.py:33)
2025-04-16 19:37:03 [   ERROR] Error processing query 'This is a query with no named entities': not enough values to unpack (expected 2, got 0) (query.py:64)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03 [ WARNING] HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0) (main.py:328)
2025-04-16 19:37:03 [    INFO] HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error" (_client.py:1740)
FAILED                                                                   [ 95%]
tests/integration/test_query_pipeline.py::test_query_invalid_request 
-------------------------------- live log call ---------------------------------
2025-04-16 19:37:03 [    INFO] rid=8ee987fa-4dff-46eb-b338-efb049592318 path=/api/v1/query method=POST (main.py:315)
2025-04-16 19:37:03 [    INFO] HTTP Request: POST http://test/api/v1/query "HTTP/1.1 422 Unprocessable Entity" (_client.py:1740)
PASSED                                                                   [100%]

==================================== ERRORS ====================================
____________________ ERROR at setup of test_query_pipeline _____________________
ScopeMismatch: You tried to access the function scoped fixture test_client with a module scoped request object. Requesting fixture stack:
integration/test_query_pipeline.py:31:  def ingested_doc_id(test_client: httpx.AsyncClient, test_document_content: str, test_document_metadata: Dict[str, Any], memgraph_repo) -> str
Requested fixture:
conftest.py:165:  def test_client(app: fastapi.applications.FastAPI, mock_graph_repo: unittest.mock.AsyncMock, mock_ingestion_service: unittest.mock.AsyncMock, mock_graph_rag_engine: unittest.mock.AsyncMock, mock_vector_store: unittest.mock.AsyncMock, mock_doc_processor: unittest.mock.AsyncMock, mock_kg_builder: unittest.mock.AsyncMock, mock_entity_extractor: unittest.mock.AsyncMock) -> AsyncGenerator[httpx.AsyncClient, NoneType]
=================================== FAILURES ===================================
________________________ test_ingest_and_keyword_search ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 149, in test_ingest_and_keyword_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x361100260>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_keyword_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent keyword search."""
        doc_content = "Integration testing involves blue widgets."
        metadata = {"source": "integration_test", "color": "blue"}
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        assert "document_id" in ingest_result
        assert "status" in ingest_result
        assert "task_id" in ingest_result
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion to process...")
        await asyncio.sleep(15)
    
        # Keyword Search directly using test_client
        search_query = "widgets"
        limit = 5
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": search_query, "limit": limit}
        )

tests/integration/test_e2e.py:149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:254: in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

settings = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')

    def create_llm_service(settings: Settings) -> LLMService: # Remove Depends
        """Creates an LLMService instance based on settings. Expects resolved settings."""
        try:
            llm_type = settings.LLM_TYPE.lower()
            logger.info(f"Creating LLMService instance of type: {llm_type}")
            if llm_type == "openai":
                # Ensure API key is handled securely
                api_key = settings.OPENAI_API_KEY.get_secret_value() if settings.OPENAI_API_KEY else None
                if not api_key:
                    logger.error("OpenAI API key is not configured.")
                    raise HTTPException(status_code=503, detail="LLM Service (OpenAI) not configured: API key missing.")
                instance = SentenceTransformerEmbeddingService(api_key=api_key, model_name=settings.LLM_MODEL_NAME)
            elif llm_type == "mock":
                instance = MockLLMService()
            else:
                logger.warning(f"Unsupported LLM_TYPE '{settings.LLM_TYPE}'. Falling back to MockLLMService.")
                instance = MockLLMService()
        except AttributeError:
            # If LLM_TYPE is not defined in settings, use mock service
            logger.warning("LLM_TYPE not found in settings. Falling back to MockLLMService.")
>           instance = MockLLMService()
E           NameError: name 'MockLLMService' is not defined

graph_rag/api/dependencies.py:102: NameError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:35:51,089 - tests.conftest - INFO - spaCy model 'en_core_web_sm' already available.
2025-04-16 19:35:51,113 - test_e2e - INFO - [Fixture] Clearing database: bolt://localhost:7687 before test.
2025-04-16 19:35:51,152 - test_e2e - INFO - [Fixture] Database cleared.
------------------------------ Captured log setup ------------------------------
INFO     tests.conftest:conftest.py:65 spaCy model 'en_core_web_sm' already available.
INFO     test_e2e:test_e2e.py:93 [Fixture] Clearing database: bolt://localhost:7687 before test.
INFO     test_e2e:test_e2e.py:95 [Fixture] Database cleared.
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:35:51,262 - graph_rag.api.main - INFO - rid=727e7cf4-46e3-4e79-8d48-1c545940cd9a path=/api/v1/ingestion/documents method=POST
2025-04-16 19:35:51,263 - graph_rag.api.dependencies - INFO - Creating DocumentProcessor instance (SimpleDocumentProcessor)
2025-04-16 19:35:51,264 - graph_rag.core.document_processor - INFO - Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
2025-04-16 19:35:51,265 - graph_rag.api.dependencies - INFO - Creating EntityExtractor instance of type: spacy
2025-04-16 19:35:51,572 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-16 19:35:51,572 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
2025-04-16 19:35:51,572 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Loading sentence-transformer model: all-MiniLM-L6-v2
2025-04-16 19:35:51,573 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-16 19:35:51,573 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-16 19:35:53,847 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Sentence-transformer model loaded successfully.
2025-04-16 19:35:53,848 - graph_rag.api.dependencies - INFO - Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
2025-04-16 19:35:53,849 - graph_rag.services.embedding - INFO - Loading embedding model: all-MiniLM-L6-v2
2025-04-16 19:35:53,850 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-16 19:35:53,850 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-16 19:35:55,927 - graph_rag.services.embedding - INFO - Embedding model loaded successfully.
2025-04-16 19:35:55,927 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-16 19:35:55,927 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-16 19:35:55,929 - graph_rag.api.routers.ingestion - INFO - [Req ID: 354555ce-9f7a-423b-b8c0-98ba97f4df6e] Received ingestion request.
2025-04-16 19:35:55,930 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test', 'color': 'blue'}
2025-04-16 19:35:55,938 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node 625534e3-38ec-4620-9dec-993c724fc810 with type Document
2025-04-16 19:35:55,938 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-16 19:35:55,959 - graph_rag.core.document_processor - INFO - Split document 625534e3-38ec-4620-9dec-993c724fc810 into 1 sentence chunks.
2025-04-16 19:35:55,959 - graph_rag.services.ingestion - INFO - Document 625534e3-38ec-4620-9dec-993c724fc810 split into 1 chunks.
2025-04-16 19:35:55,959 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-16 19:35:55,959 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: 21e77928-7944-4952-ad46-478c4974538a, Embedding is None: True
2025-04-16 19:35:55,961 - graph_rag.services.ingestion - ERROR - Failed to save chunk 21e77928-7944-4952-ad46-478c4974538a or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:35:55,962 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-16 19:35:55,963 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-a4e765d2-85df-4dd1-b0f1-792ce67444fb: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:35:55,966 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:35:55,966 - test_e2e - INFO - Waiting 5 seconds for ingestion to process...
2025-04-16 19:36:10,967 - graph_rag.api.main - INFO - rid=cb1a9bee-30ea-42f7-bd92-67df189df4cb path=/api/v1/search/query method=POST
2025-04-16 19:36:10,970 - graph_rag.api.dependencies - WARNING - LLM_TYPE not found in settings. Falling back to MockLLMService.
2025-04-16 19:36:10,970 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=727e7cf4-46e3-4e79-8d48-1c545940cd9a path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.dependencies:dependencies.py:120 Creating DocumentProcessor instance (SimpleDocumentProcessor)
INFO     graph_rag.core.document_processor:document_processor.py:104 Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
INFO     graph_rag.api.dependencies:dependencies.py:130 Creating EntityExtractor instance of type: spacy
INFO     graph_rag.core.entity_extractor:entity_extractor.py:74 spaCy model 'en_core_web_sm' loaded successfully.
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:18 Loading sentence-transformer model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:20 Sentence-transformer model loaded successfully.
INFO     graph_rag.api.dependencies:dependencies.py:226 Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
INFO     graph_rag.services.embedding:embedding.py:27 Loading embedding model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.services.embedding:embedding.py:31 Embedding model loaded successfully.
WARNING  graph_rag.api.dependencies:dependencies.py:311 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 354555ce-9f7a-423b-b8c0-98ba97f4df6e] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test', 'color': 'blue'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node 625534e3-38ec-4620-9dec-993c724fc810 with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document 625534e3-38ec-4620-9dec-993c724fc810 into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document 625534e3-38ec-4620-9dec-993c724fc810 split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk 21e77928-7944-4952-ad46-478c4974538a or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-a4e765d2-85df-4dd1-b0f1-792ce67444fb: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:143 Waiting 5 seconds for ingestion to process...
INFO     graph_rag.api.main:main.py:315 rid=cb1a9bee-30ea-42f7-bd92-67df189df4cb path=/api/v1/search/query method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:101 LLM_TYPE not found in settings. Falling back to MockLLMService.
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
--------------------------- Captured stdout teardown ---------------------------
2025-04-16 19:36:11,498 - test_e2e - INFO - [Fixture] Closed DB connection after test.
---------------------------- Captured log teardown -----------------------------
INFO     test_e2e:test_e2e.py:106 [Fixture] Closed DB connection after test.
________________________ test_ingest_and_vector_search _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 189, in test_ingest_and_vector_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x361de83e0>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_vector_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent vector similarity search."""
        doc_content = "Semantic search looks for meaning, like finding vehicles when asked about cars."
        metadata = {"source": "integration_test", "topic": "search"}
        query = "automobiles"
        limit = 3
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion and embedding to process...")
        await asyncio.sleep(15)
    
        # Vector Search directly using test_client
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "vector", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:254: in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

settings = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')

    def create_llm_service(settings: Settings) -> LLMService: # Remove Depends
        """Creates an LLMService instance based on settings. Expects resolved settings."""
        try:
            llm_type = settings.LLM_TYPE.lower()
            logger.info(f"Creating LLMService instance of type: {llm_type}")
            if llm_type == "openai":
                # Ensure API key is handled securely
                api_key = settings.OPENAI_API_KEY.get_secret_value() if settings.OPENAI_API_KEY else None
                if not api_key:
                    logger.error("OpenAI API key is not configured.")
                    raise HTTPException(status_code=503, detail="LLM Service (OpenAI) not configured: API key missing.")
                instance = SentenceTransformerEmbeddingService(api_key=api_key, model_name=settings.LLM_MODEL_NAME)
            elif llm_type == "mock":
                instance = MockLLMService()
            else:
                logger.warning(f"Unsupported LLM_TYPE '{settings.LLM_TYPE}'. Falling back to MockLLMService.")
                instance = MockLLMService()
        except AttributeError:
            # If LLM_TYPE is not defined in settings, use mock service
            logger.warning("LLM_TYPE not found in settings. Falling back to MockLLMService.")
>           instance = MockLLMService()
E           NameError: name 'MockLLMService' is not defined

graph_rag/api/dependencies.py:102: NameError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:11,502 - test_e2e - INFO - [Fixture] Clearing database: bolt://localhost:7687 before test.
2025-04-16 19:36:11,509 - test_e2e - INFO - [Fixture] Database cleared.
------------------------------ Captured log setup ------------------------------
INFO     test_e2e:test_e2e.py:93 [Fixture] Clearing database: bolt://localhost:7687 before test.
INFO     test_e2e:test_e2e.py:95 [Fixture] Database cleared.
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:11,611 - graph_rag.api.main - INFO - rid=b4bdd9a2-a461-4ae3-9dc4-df11a94dbc93 path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:11,614 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-16 19:36:11,615 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-16 19:36:11,615 - graph_rag.api.routers.ingestion - INFO - [Req ID: 70bc8575-b04e-45f5-9d50-4549466367a1] Received ingestion request.
2025-04-16 19:36:11,615 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test', 'topic': 'search'}
2025-04-16 19:36:11,622 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f with type Document
2025-04-16 19:36:11,622 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-16 19:36:11,622 - graph_rag.core.document_processor - INFO - Split document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f into 1 sentence chunks.
2025-04-16 19:36:11,622 - graph_rag.services.ingestion - INFO - Document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f split into 1 chunks.
2025-04-16 19:36:11,622 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-16 19:36:11,622 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: ce433f34-6215-4cbe-b5b4-2571f63a5d36, Embedding is None: True
2025-04-16 19:36:11,623 - graph_rag.services.ingestion - ERROR - Failed to save chunk ce433f34-6215-4cbe-b5b4-2571f63a5d36 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:36:11,623 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-16 19:36:11,623 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-bebceee6-168c-4ae3-ab9d-d06e0aa2e0c9: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:36:11,624 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:11,624 - test_e2e - INFO - Waiting 5 seconds for ingestion and embedding to process...
2025-04-16 19:36:26,626 - graph_rag.api.main - INFO - rid=2632745c-339d-410a-9c18-b751d205a03a path=/api/v1/search/query method=POST
2025-04-16 19:36:26,628 - graph_rag.api.dependencies - WARNING - LLM_TYPE not found in settings. Falling back to MockLLMService.
2025-04-16 19:36:26,628 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=b4bdd9a2-a461-4ae3-9dc4-df11a94dbc93 path=/api/v1/ingestion/documents method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:311 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 70bc8575-b04e-45f5-9d50-4549466367a1] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test', 'topic': 'search'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document a4f4ef22-ce08-4c99-a7fa-e976ad97aa5f split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk ce433f34-6215-4cbe-b5b4-2571f63a5d36 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-bebceee6-168c-4ae3-ab9d-d06e0aa2e0c9: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:185 Waiting 5 seconds for ingestion and embedding to process...
INFO     graph_rag.api.main:main.py:315 rid=2632745c-339d-410a-9c18-b751d205a03a path=/api/v1/search/query method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:101 LLM_TYPE not found in settings. Falling back to MockLLMService.
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
--------------------------- Captured stdout teardown ---------------------------
2025-04-16 19:36:26,928 - test_e2e - INFO - [Fixture] Closed DB connection after test.
---------------------------- Captured log teardown -----------------------------
INFO     test_e2e:test_e2e.py:106 [Fixture] Closed DB connection after test.
_________________________ test_search_nonexistent_term _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 215, in test_search_nonexistent_term
    |     keyword_response = await e2e_test_client.post(
    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x3613c2420>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_search_nonexistent_term(e2e_test_client: httpx.AsyncClient):
        """Verify searches for unlikely terms return empty results."""
        query = "zzzyyyxxx_nonexistent_term_qwerty"
        limit = 5
    
        # Keyword Search directly using test_client
>       keyword_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:254: in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

settings = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')

    def create_llm_service(settings: Settings) -> LLMService: # Remove Depends
        """Creates an LLMService instance based on settings. Expects resolved settings."""
        try:
            llm_type = settings.LLM_TYPE.lower()
            logger.info(f"Creating LLMService instance of type: {llm_type}")
            if llm_type == "openai":
                # Ensure API key is handled securely
                api_key = settings.OPENAI_API_KEY.get_secret_value() if settings.OPENAI_API_KEY else None
                if not api_key:
                    logger.error("OpenAI API key is not configured.")
                    raise HTTPException(status_code=503, detail="LLM Service (OpenAI) not configured: API key missing.")
                instance = SentenceTransformerEmbeddingService(api_key=api_key, model_name=settings.LLM_MODEL_NAME)
            elif llm_type == "mock":
                instance = MockLLMService()
            else:
                logger.warning(f"Unsupported LLM_TYPE '{settings.LLM_TYPE}'. Falling back to MockLLMService.")
                instance = MockLLMService()
        except AttributeError:
            # If LLM_TYPE is not defined in settings, use mock service
            logger.warning("LLM_TYPE not found in settings. Falling back to MockLLMService.")
>           instance = MockLLMService()
E           NameError: name 'MockLLMService' is not defined

graph_rag/api/dependencies.py:102: NameError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:26,930 - test_e2e - INFO - [Fixture] Clearing database: bolt://localhost:7687 before test.
2025-04-16 19:36:26,935 - test_e2e - INFO - [Fixture] Database cleared.
------------------------------ Captured log setup ------------------------------
INFO     test_e2e:test_e2e.py:93 [Fixture] Clearing database: bolt://localhost:7687 before test.
INFO     test_e2e:test_e2e.py:95 [Fixture] Database cleared.
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:27,038 - graph_rag.api.main - INFO - rid=f3c24b64-8970-4747-ab3c-07bab7d13214 path=/api/v1/search/query method=POST
2025-04-16 19:36:27,040 - graph_rag.api.dependencies - WARNING - LLM_TYPE not found in settings. Falling back to MockLLMService.
2025-04-16 19:36:27,040 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=f3c24b64-8970-4747-ab3c-07bab7d13214 path=/api/v1/search/query method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:101 LLM_TYPE not found in settings. Falling back to MockLLMService.
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: name 'MockLLMService' is not defined
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    |     _singletons["llm_service"] = create_llm_service(settings=settings)
    |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    |     instance = MockLLMService()
    |                ^^^^^^^^^^^^^^
    | NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 254, in get_llm_service
    _singletons["llm_service"] = create_llm_service(settings=settings)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 102, in create_llm_service
    instance = MockLLMService()
               ^^^^^^^^^^^^^^
NameError: name 'MockLLMService' is not defined. Did you mean: 'LLMService'?
--------------------------- Captured stdout teardown ---------------------------
2025-04-16 19:36:27,335 - test_e2e - INFO - [Fixture] Closed DB connection after test.
---------------------------- Captured log teardown -----------------------------
INFO     test_e2e:test_e2e.py:106 [Fixture] Closed DB connection after test.
____________________________ test_ingest_and_delete ____________________________

e2e_test_client = <httpx.AsyncClient object at 0x361381340>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_delete(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent deletion."""
        doc_content = "This document is created solely for deletion testing."
        metadata = {"source": "integration_test_delete"}
    
        # 1. Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": False} # No embedding needed
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        assert "document_id" in ingest_result
        assert "status" in ingest_result
        assert "task_id" in ingest_result
        doc_id = ingest_result["document_id"]
    
        # 2. Verify existence (optional - depends on having a GET /document/{id} endpoint)
        # get_response = await test_client.get(f"{BASE_URL}/documents/{doc_id}")
        # assert get_response.status_code == status.HTTP_200_OK
    
        # 3. Delete directly using test_client
        delete_response = await e2e_test_client.delete(f"{BASE_URL}/documents/{doc_id}")
        if delete_response.status_code != status.HTTP_204_NO_CONTENT:
            print(f"Delete response status: {delete_response.status_code}, body: {delete_response.text}")
>       assert delete_response.status_code == status.HTTP_204_NO_CONTENT
E       assert 404 == 204
E        +  where 404 = <Response [404 Not Found]>.status_code
E        +  and   204 = status.HTTP_204_NO_CONTENT

tests/integration/test_e2e.py:267: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:27,338 - test_e2e - INFO - [Fixture] Clearing database: bolt://localhost:7687 before test.
2025-04-16 19:36:27,342 - test_e2e - INFO - [Fixture] Database cleared.
------------------------------ Captured log setup ------------------------------
INFO     test_e2e:test_e2e.py:93 [Fixture] Clearing database: bolt://localhost:7687 before test.
INFO     test_e2e:test_e2e.py:95 [Fixture] Database cleared.
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:27,444 - graph_rag.api.main - INFO - rid=28eee7cf-7617-4311-9185-0d7f9d933beb path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:27,446 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-16 19:36:27,446 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-16 19:36:27,447 - graph_rag.api.routers.ingestion - INFO - [Req ID: 0f54c7ff-39d4-4a3c-9c33-d96ab5a45cdb] Received ingestion request.
2025-04-16 19:36:27,447 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test_delete'}
2025-04-16 19:36:27,454 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node f5ee47f1-5882-4000-8b79-74fdb9d43481 with type Document
2025-04-16 19:36:27,454 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-16 19:36:27,454 - graph_rag.core.document_processor - INFO - Split document f5ee47f1-5882-4000-8b79-74fdb9d43481 into 1 sentence chunks.
2025-04-16 19:36:27,455 - graph_rag.services.ingestion - INFO - Document f5ee47f1-5882-4000-8b79-74fdb9d43481 split into 1 chunks.
2025-04-16 19:36:27,455 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-16 19:36:27,455 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: 73a6b2d5-6925-472a-a1c6-d6eae39896df, Embedding is None: True
2025-04-16 19:36:27,455 - graph_rag.services.ingestion - ERROR - Failed to save chunk 73a6b2d5-6925-472a-a1c6-d6eae39896df or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-16 19:36:27,456 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-16 19:36:27,456 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-6935c20e-6606-4b52-8cdc-b83da4108119: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-16 19:36:27,456 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:27,457 - graph_rag.api.main - INFO - rid=1998ae4f-3b30-450f-98f0-df207f53691c path=/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 method=DELETE
2025-04-16 19:36:27,458 - graph_rag.api.routers.documents - INFO - Attempting to delete document doc-6935c20e-6606-4b52-8cdc-b83da4108119 and its chunks.
2025-04-16 19:36:27,462 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found, nothing deleted (deleted flag false).
2025-04-16 19:36:27,462 - graph_rag.api.routers.documents - WARNING - Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found for deletion.
2025-04-16 19:36:27,462 - graph_rag.api.main - WARNING - HTTP exception for http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119: 404 - Document with id doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found or could not be deleted.
2025-04-16 19:36:27,463 - httpx - INFO - HTTP Request: DELETE http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 "HTTP/1.1 404 Not Found"
Delete response status: 404, body: {"detail":"Document with id doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found or could not be deleted."}
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=28eee7cf-7617-4311-9185-0d7f9d933beb path=/api/v1/ingestion/documents method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:311 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 0f54c7ff-39d4-4a3c-9c33-d96ab5a45cdb] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test_delete'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node f5ee47f1-5882-4000-8b79-74fdb9d43481 with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document f5ee47f1-5882-4000-8b79-74fdb9d43481 into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document f5ee47f1-5882-4000-8b79-74fdb9d43481 split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk 73a6b2d5-6925-472a-a1c6-d6eae39896df or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-6935c20e-6606-4b52-8cdc-b83da4108119: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     graph_rag.api.main:main.py:315 rid=1998ae4f-3b30-450f-98f0-df207f53691c path=/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 method=DELETE
INFO     graph_rag.api.routers.documents:documents.py:126 Attempting to delete document doc-6935c20e-6606-4b52-8cdc-b83da4108119 and its chunks.
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:947 Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found, nothing deleted (deleted flag false).
WARNING  graph_rag.api.routers.documents:documents.py:130 Document doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found for deletion.
WARNING  graph_rag.api.main:main.py:328 HTTP exception for http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119: 404 - Document with id doc-6935c20e-6606-4b52-8cdc-b83da4108119 not found or could not be deleted.
INFO     httpx:_client.py:1740 HTTP Request: DELETE http://localhost:8000/api/v1/documents/doc-6935c20e-6606-4b52-8cdc-b83da4108119 "HTTP/1.1 404 Not Found"
--------------------------- Captured stdout teardown ---------------------------
2025-04-16 19:36:27,471 - test_e2e - INFO - [Fixture] Closed DB connection after test.
---------------------------- Captured log teardown -----------------------------
INFO     test_e2e:test_e2e.py:106 [Fixture] Closed DB connection after test.
__________________ test_process_and_store_document_cli_logic ___________________

file_path = PosixPath('/var/folders/h4/rhh6b9dd7779n60jjvzcpx580000gn/T/tmpydbl1c5r.txt')
metadata_dict = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
graph_repository = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x36123dd90>
doc_processor = <graph_rag.core.document_processor.SimpleDocumentProcessor object at 0x36123fda0>
entity_extractor = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x361248950>

    async def process_and_store_document(
        file_path: Path,
        metadata_dict: Dict[str, Any],
        graph_repository: MemgraphRepository,
        doc_processor: SimpleDocumentProcessor,
        entity_extractor: SpacyEntityExtractor
    ) -> None:
        """Process a document and store it in the graph database."""
        try:
            # Read document content
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
    
            # Generate document ID
            doc_id = str(uuid.uuid4())
    
            # Process document into chunks
>           chunks = await doc_processor.process_document(content)
E           AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'

graph_rag/cli/commands/ingest.py:76: AttributeError

During handling of the above exception, another exception occurred:

test_document = '\n    The Eiffel Tower is a wrought-iron lattice tower in Paris, France.\n    It was designed by Gustave Eiffel and completed in 1889.\n    The tower is 330 meters tall and is the most-visited paid monument in the world.\n    '
test_metadata = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x36123dd90>

    @pytest.mark.asyncio
    async def test_process_and_store_document_cli_logic( # Rename test for clarity
        test_document: str,
        test_metadata: Dict[str, Any],
        memgraph_repo: MemgraphGraphRepository # Use the fixture from conftest
    ):
        """Test the core document processing and storage logic from the CLI command."""
        doc_content_for_query = test_document # Store for assertion query
    
        # Create a temporary file with the test document content
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", encoding='utf-8', delete=False) as f:
            f.write(test_document)
            file_path = Path(f.name)
    
        # Define a query to find the document later based on unique metadata
        find_doc_query = "MATCH (d:Document {source: $source}) RETURN d.id as id, d.content as content, d.metadata as metadata LIMIT 1"
        find_doc_params = {"source": test_metadata["source"]}
    
        try:
            # Initialize components needed by the function
            doc_processor = SimpleDocumentProcessor(chunk_strategy="paragraph")
            entity_extractor = SpacyEntityExtractor() # Assumes model is downloaded/available
    
            # Call the CLI processing function directly
>           await process_and_store_document(
                file_path=file_path,
                metadata_dict=test_metadata,
                graph_repository=memgraph_repo, # Pass the correct repo instance
                doc_processor=doc_processor,
                entity_extractor=entity_extractor
                # No kg_builder needed here
            )

tests/integration/test_ingest_command.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

file_path = PosixPath('/var/folders/h4/rhh6b9dd7779n60jjvzcpx580000gn/T/tmpydbl1c5r.txt')
metadata_dict = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
graph_repository = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x36123dd90>
doc_processor = <graph_rag.core.document_processor.SimpleDocumentProcessor object at 0x36123fda0>
entity_extractor = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x361248950>

    async def process_and_store_document(
        file_path: Path,
        metadata_dict: Dict[str, Any],
        graph_repository: MemgraphRepository,
        doc_processor: SimpleDocumentProcessor,
        entity_extractor: SpacyEntityExtractor
    ) -> None:
        """Process a document and store it in the graph database."""
        try:
            # Read document content
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
    
            # Generate document ID
            doc_id = str(uuid.uuid4())
    
            # Process document into chunks
            chunks = await doc_processor.process_document(content)
    
            # Store document
            await graph_repository.add_document({
                "id": doc_id,
                "content": content,
                "metadata": metadata_dict
            })
    
            # Process and store each chunk
            for chunk in chunks:
                # Generate chunk ID
                chunk_id = str(uuid.uuid4())
    
                # Extract entities from chunk
                entities = await entity_extractor.extract_entities(chunk.text)
    
                # Store chunk
                await graph_repository.add_chunk({
                    "id": chunk_id,
                    "text": chunk.text,
                    "document_id": doc_id,
                    "embedding": None  # TODO: Add embedding support
                })
    
                # Store entities and create relationships
                entity_ids = []
                for entity in entities:
                    entity_id = str(uuid.uuid4())
                    await graph_repository.add_entity({
                        "id": entity_id,
                        "label": entity.label,
                        "text": entity.text
                    })
                    entity_ids.append(entity_id)
    
                # Link chunk to entities
                if entity_ids:
                    await graph_repository.link_chunk_to_entities(chunk_id, entity_ids)
    
            typer.echo(f"Successfully ingested document {doc_id}")
    
        except Exception as e:
            logger.error(f"Error processing document: {str(e)}", exc_info=True)
            typer.echo(f"Error processing document: {str(e)}", err=True)
>           raise typer.Exit(1)
E           click.exceptions.Exit: 1

graph_rag/cli/commands/ingest.py:121: Exit

During handling of the above exception, another exception occurred:

test_document = '\n    The Eiffel Tower is a wrought-iron lattice tower in Paris, France.\n    It was designed by Gustave Eiffel and completed in 1889.\n    The tower is 330 meters tall and is the most-visited paid monument in the world.\n    '
test_metadata = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x36123dd90>

    @pytest.mark.asyncio
    async def test_process_and_store_document_cli_logic( # Rename test for clarity
        test_document: str,
        test_metadata: Dict[str, Any],
        memgraph_repo: MemgraphGraphRepository # Use the fixture from conftest
    ):
        """Test the core document processing and storage logic from the CLI command."""
        doc_content_for_query = test_document # Store for assertion query
    
        # Create a temporary file with the test document content
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", encoding='utf-8', delete=False) as f:
            f.write(test_document)
            file_path = Path(f.name)
    
        # Define a query to find the document later based on unique metadata
        find_doc_query = "MATCH (d:Document {source: $source}) RETURN d.id as id, d.content as content, d.metadata as metadata LIMIT 1"
        find_doc_params = {"source": test_metadata["source"]}
    
        try:
            # Initialize components needed by the function
            doc_processor = SimpleDocumentProcessor(chunk_strategy="paragraph")
            entity_extractor = SpacyEntityExtractor() # Assumes model is downloaded/available
    
            # Call the CLI processing function directly
            await process_and_store_document(
                file_path=file_path,
                metadata_dict=test_metadata,
                graph_repository=memgraph_repo, # Pass the correct repo instance
                doc_processor=doc_processor,
                entity_extractor=entity_extractor
                # No kg_builder needed here
            )
    
            # Verify document was stored by querying metadata/content
            # Allow some time for potential async writes if necessary, though await should handle it
            await asyncio.sleep(0.1)
            result = await memgraph_repo._execute_read_query(find_doc_query, find_doc_params)
    
            assert result is not None and len(result) == 1, f"Document with source '{test_metadata['source']}' not found."
            stored_doc_data = result[0]
            doc_id = stored_doc_data["id"] # Get the generated ID for further checks
    
            assert stored_doc_data["content"] == doc_content_for_query
            assert stored_doc_data["metadata"] == test_metadata
    
            # Verify chunks were created and linked (Requires get_chunks_by_document_id or direct query)
            # Example direct query:
            chunk_check_query = "MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk) RETURN count(c) as count"
            chunk_result = await memgraph_repo._execute_read_query(chunk_check_query, {"doc_id": doc_id})
            assert chunk_result[0]["count"] > 0, "No chunks found linked to the document."
    
            # Verify entities were extracted and linked
            entity_check_query = """
            MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk)<-[:MENTIONED_IN]-(e:Entity)
            RETURN DISTINCT e.name as name
            """
            # Note: process_and_store_document stores entity 'text', not 'name'. Adjust query/code.
            # Assuming entity node has 'text' property based on process_and_store_document code:
            entity_check_query_alt = """
            MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk)-[:MENTIONS]->(e:Entity)
            RETURN DISTINCT e.text as name
            """ # Relationship is :MENTIONS based on process_and_store_document
            result_entities = await memgraph_repo._execute_read_query(entity_check_query_alt, {"doc_id": doc_id})
    
            extracted_entities = {r["name"] for r in result_entities}
            logger.info(f"Extracted entities for doc {doc_id}: {extracted_entities}")
            assert len(extracted_entities) > 0
            assert "Eiffel Tower" in extracted_entities
            assert "Paris" in extracted_entities
            assert "Gustave Eiffel" in extracted_entities
    
        finally:
            # Clean up the temporary file
            if file_path.exists():
                file_path.unlink()
    
            # Clean up the graph using the retrieved doc_id if found
            if 'doc_id' in locals() and doc_id:
                 await memgraph_repo._execute_write_query("MATCH (d:Document {id: $doc_id}) DETACH DELETE d", {"doc_id": doc_id})
            else: # Fallback cleanup based on metadata if doc_id wasn't retrieved
>                await memgraph_repo._execute_write_query("MATCH (d:Document {source: $source}) DETACH DELETE d", find_doc_params)
E                AttributeError: 'MemgraphGraphRepository' object has no attribute '_execute_write_query'

tests/integration/test_ingest_command.py:133: AttributeError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:27,877 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:27,880 - graph_rag.core.document_processor - INFO - Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
2025-04-16 19:36:28,198 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-16 19:36:28,198 - graph_rag.cli.commands.ingest - ERROR - Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/cli/commands/ingest.py", line 76, in process_and_store_document
    chunks = await doc_processor.process_document(content)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'
----------------------------- Captured stderr call -----------------------------
Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.core.document_processor:document_processor.py:104 Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
INFO     graph_rag.core.entity_extractor:entity_extractor.py:74 spaCy model 'en_core_web_sm' loaded successfully.
ERROR    graph_rag.cli.commands.ingest:ingest.py:119 Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/cli/commands/ingest.py", line 76, in process_and_store_document
    chunks = await doc_processor.process_document(content)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'
_______________________ test_document_ingestion_pipeline _______________________

test_client = <httpx.AsyncClient object at 0x36120a7b0>
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x361c29b80>

    async def test_document_ingestion_pipeline(test_client: AsyncClient, memgraph_repo):
        """Test complete document ingestion pipeline with database verification."""
        # 1. Ingest document
        doc_content = "Test document for integration testing. Contains some entities like Alice and Bob."
        metadata = {"source": "integration-test", "category": "test"}
    
        response = await ingest_test_document(test_client, doc_content, metadata)
        doc_id = response["document_id"]
        task_id = response["task_id"]
    
        assert response["status"] == "processing"
        assert doc_id.startswith("doc-")
    
        # 2. Wait for background processing (with timeout)
        max_attempts = 10
        attempt = 0
        doc = None # Initialize doc
        while attempt < max_attempts:
            # Check if document exists in database
            # Use memgraph_repo fixture now
            doc = await memgraph_repo.get_document_by_id(doc_id)
            if doc is not None:
                break
            await asyncio.sleep(1)  # Wait 1 second between checks
            attempt += 1
    
>       assert doc is not None, "Document not found in database after ingestion"
E       AssertionError: Document not found in database after ingestion
E       assert None is not None

tests/integration/test_ingestion_integration.py:81: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:28,287 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:28,290 - graph_rag.api.main - INFO - rid=004a45c3-b710-4324-9793-efae251871bd path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:28,291 - graph_rag.api.routers.ingestion - INFO - [Req ID: c7be4b0d-a528-4e44-bde0-b5738ab63b7d] Received ingestion request.
2025-04-16 19:36:28,292 - graph_rag.api.routers.ingestion - INFO - Document doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd processed successfully.
2025-04-16 19:36:28,292 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:28,296 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:29,302 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:30,308 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:31,314 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:32,319 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:33,325 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:34,330 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:35,336 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:36,341 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
2025-04-16 19:36:37,347 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=004a45c3-b710-4324-9793-efae251871bd path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: c7be4b0d-a528-4e44-bde0-b5738ab63b7d] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd processed successfully.
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-7481a24a-a6e1-4b7f-9272-7ba14b5c95fd
____________________ test_concurrent_ingestion_integration _____________________

test_client = <httpx.AsyncClient object at 0x361c28c80>
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x361c2af30>

    async def test_concurrent_ingestion_integration(test_client: AsyncClient, memgraph_repo):
        """Test concurrent document ingestion with database verification."""
        async def ingest_and_verify(client: AsyncClient, repo, content: str, metadata: Dict[str, Any]):
            # Ingest document
            response = await ingest_test_document(client, content, metadata)
            doc_id = response["document_id"]
    
            # Wait for processing
            max_attempts = 10
            attempt = 0
            doc = None
            while attempt < max_attempts:
                doc = await repo.get_document_by_id(doc_id)
                if doc is not None:
                    break
                await asyncio.sleep(1)
                attempt += 1
    
            assert doc is not None, f"Document {doc_id} not found in database"
            assert doc.content == content
            return doc_id
    
        # Create multiple ingestion tasks
        tasks = [
            ingest_and_verify(
                test_client, # Pass client
                memgraph_repo, # Pass repo
                f"Concurrent test document {i}",
                {"source": "concurrent-test", "index": i}
            )
            for i in range(3)
        ]
    
        # Run all tasks concurrently
>       doc_ids = await asyncio.gather(*tasks)

tests/integration/test_ingestion_integration.py:161: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x361c28c80>
repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x361c2af30>
content = 'Concurrent test document 0'
metadata = {'index': 0, 'source': 'concurrent-test'}

    async def ingest_and_verify(client: AsyncClient, repo, content: str, metadata: Dict[str, Any]):
        # Ingest document
        response = await ingest_test_document(client, content, metadata)
        doc_id = response["document_id"]
    
        # Wait for processing
        max_attempts = 10
        attempt = 0
        doc = None
        while attempt < max_attempts:
            doc = await repo.get_document_by_id(doc_id)
            if doc is not None:
                break
            await asyncio.sleep(1)
            attempt += 1
    
>       assert doc is not None, f"Document {doc_id} not found in database"
E       AssertionError: Document doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 not found in database
E       assert None is not None

tests/integration/test_ingestion_integration.py:145: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:38,370 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:38,373 - graph_rag.api.main - INFO - rid=64f11c87-3417-40a0-9a4b-5d3b0896e37e path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:38,373 - graph_rag.api.main - INFO - rid=cb91bc46-a528-45b9-9f17-43d469a15f03 path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:38,373 - graph_rag.api.main - INFO - rid=aff056f2-0800-434c-83ca-c85794711547 path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:38,377 - graph_rag.api.routers.ingestion - INFO - [Req ID: ba8b6207-1a75-4d89-93e4-afd4bbbb337b] Received ingestion request.
2025-04-16 19:36:38,377 - graph_rag.api.routers.ingestion - INFO - [Req ID: dd3b119f-2881-4c28-85cd-5acc890e47ce] Received ingestion request.
2025-04-16 19:36:38,377 - graph_rag.api.routers.ingestion - INFO - [Req ID: 82d62035-c03a-4425-8de2-0b80b61455aa] Received ingestion request.
2025-04-16 19:36:38,378 - graph_rag.api.routers.ingestion - INFO - Document doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 processed successfully.
2025-04-16 19:36:38,378 - graph_rag.api.routers.ingestion - INFO - Document doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb processed successfully.
2025-04-16 19:36:38,378 - graph_rag.api.routers.ingestion - INFO - Document doc-02e69f36-9a40-454d-b2b1-e63dc0361634 processed successfully.
2025-04-16 19:36:38,378 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:38,378 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:38,382 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:38,391 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:38,391 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:38,391 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:39,403 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:39,403 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:39,403 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:40,417 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:40,417 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:40,418 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:41,433 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:41,433 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:41,434 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:42,444 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:42,444 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:42,444 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:43,456 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:43,456 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:43,456 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:44,467 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:44,467 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:44,467 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:45,483 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:45,483 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:45,483 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:46,494 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:46,495 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:46,495 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
2025-04-16 19:36:47,506 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
2025-04-16 19:36:47,506 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
2025-04-16 19:36:47,506 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=64f11c87-3417-40a0-9a4b-5d3b0896e37e path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.main:main.py:315 rid=cb91bc46-a528-45b9-9f17-43d469a15f03 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.main:main.py:315 rid=aff056f2-0800-434c-83ca-c85794711547 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: ba8b6207-1a75-4d89-93e4-afd4bbbb337b] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: dd3b119f-2881-4c28-85cd-5acc890e47ce] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 82d62035-c03a-4425-8de2-0b80b61455aa] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9 processed successfully.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb processed successfully.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-02e69f36-9a40-454d-b2b1-e63dc0361634 processed successfully.
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-d1de790c-863c-4e6e-9055-3a82f2d0dad9
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-186a550e-25c1-44dd-bbb3-0c6ef1645bbb
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-02e69f36-9a40-454d-b2b1-e63dc0361634
__________________ test_large_document_ingestion_integration ___________________

test_client = <httpx.AsyncClient object at 0x361381370>
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x361c2a930>

    async def test_large_document_ingestion_integration(test_client: AsyncClient, memgraph_repo):
        """Test ingestion of a large document with database verification."""
        # Create a large document (~100KB)
        large_content = "Large test document. " * 5000
        metadata = {"source": "large-doc-test", "size": "100KB"}
    
        response = await ingest_test_document(test_client, large_content, metadata)
        doc_id = response["document_id"]
    
        # Wait for processing
        max_attempts = 15  # Give more time for large document
        attempt = 0
        doc = None
        while attempt < max_attempts:
            doc = await memgraph_repo.get_document_by_id(doc_id)
            if doc is not None:
                break
            await asyncio.sleep(1)
            attempt += 1
    
>       assert doc is not None, "Large document not found in database"
E       AssertionError: Large document not found in database
E       assert None is not None

tests/integration/test_ingestion_integration.py:192: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:36:48,530 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:36:48,533 - graph_rag.api.main - INFO - rid=985a0129-36fb-4a89-b701-7e6aed1ae544 path=/api/v1/ingestion/documents method=POST
2025-04-16 19:36:48,534 - graph_rag.api.routers.ingestion - INFO - [Req ID: 1bafa9ca-a77f-4bfc-9f40-e01ca14b7cdc] Received ingestion request.
2025-04-16 19:36:48,535 - graph_rag.api.routers.ingestion - INFO - Document doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 processed successfully.
2025-04-16 19:36:48,535 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:36:48,540 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:49,545 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:50,555 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:51,559 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:52,566 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:53,572 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:54,578 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:55,584 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:56,591 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:57,596 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:58,603 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:36:59,609 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:37:00,616 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:37:01,622 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
2025-04-16 19:37:02,628 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=985a0129-36fb-4a89-b701-7e6aed1ae544 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 1bafa9ca-a77f-4bfc-9f40-e01ca14b7cdc] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-99d88c07-6c55-43e4-b304-c72f1f6a4438 processed successfully.
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:289 Document not found with ID: doc-99d88c07-6c55-43e4-b304-c72f1f6a4438
_______________________ test_error_handling_integration ________________________

test_client = <httpx.AsyncClient object at 0x361c2a540>
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x361c41ac0>

    async def test_error_handling_integration(test_client: AsyncClient, memgraph_repo):
        """Test error handling during ingestion (e.g., empty content)."""
        # Test with invalid content (empty)
        response = await test_client.post(
            "/api/v1/ingestion/documents",
            json={"content": "", "metadata": {"source": "error-test"}}
        )
    
        # API should reject invalid input upfront (assuming validation added)
        # Adjust assertion based on actual API validation behavior
        # assert response.status_code == status.HTTP_400_BAD_REQUEST
        # For now, assume it might still return 202 if validation is loose
>       assert response.status_code == status.HTTP_202_ACCEPTED
E       assert 422 == 202
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code
E        +  and   202 = status.HTTP_202_ACCEPTED

tests/integration/test_ingestion_integration.py:216: AssertionError
---------------------------- Captured stdout setup -----------------------------
2025-04-16 19:37:03,652 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:37:03,654 - graph_rag.api.main - INFO - rid=08009218-7e35-437b-be83-8e66bb7fc9cc path=/api/v1/ingestion/documents method=POST
2025-04-16 19:37:03,656 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 422 Unprocessable Entity"
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=08009218-7e35-437b-be83-8e66bb7fc9cc path=/api/v1/ingestion/documents method=POST
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 422 Unprocessable Entity"
_______________________________ test_basic_query _______________________________

test_client = <httpx.AsyncClient object at 0x361c431d0>

    @pytest.mark.asyncio
    async def test_basic_query(test_client: AsyncClient):
        """
        Test the basic query endpoint.
        1. Ingest a known document.
        2. Query for information related to the document.
        3. Assert the response contains relevant context (e.g., chunk content).
        """
        # 1. Ingest a known document
        doc_content = "The Eiffel Tower is located in Paris, the capital of France."
        metadata = {"source": "query-test-basic"}
        try:
            # Use the local helper or inline the call
            doc_id = await ingest_doc_helper(test_client, doc_content, metadata)
            # doc_id = await ingest_test_document(test_client, doc_content, metadata) # If using imported helper
            logger.info(f"Ingested document {doc_id} for query test.")
        except Exception as e:
            pytest.fail(f"Failed to ingest test document: {e}")
    
        # 2. Query for information
        query_text = "Where is the Eiffel Tower?"
        response = await test_client.post(
            "/api/v1/query",
            json={
                "query_text": query_text,
                "k": 5
            }
        )
    
        # 3. Assertions
>       assert response.status_code == status.HTTP_200_OK
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code
E        +  and   200 = status.HTTP_200_OK

tests/integration/test_query_pipeline.py:165: AssertionError
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:37:03,677 - graph_rag.api.main - INFO - rid=eb395961-c9f4-4a72-a206-68f2e355c8f5 path=/api/v1/ingestion/documents method=POST
2025-04-16 19:37:03,679 - graph_rag.api.routers.ingestion - INFO - [Req ID: 7a058ac9-5941-4406-8623-875c38b20cfb] Received ingestion request.
2025-04-16 19:37:03,679 - graph_rag.api.routers.ingestion - INFO - Document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 processed successfully.
2025-04-16 19:37:03,679 - httpx - INFO - HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-16 19:37:03,680 - test_query_pipeline - INFO - Ingested document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 for query test.
2025-04-16 19:37:03,680 - graph_rag.api.main - INFO - rid=0f4287f7-a357-478b-88c9-3e9796383ee9 path=/api/v1/query method=POST
2025-04-16 19:37:03,681 - graph_rag.api.routers.query - INFO - Received query: Where is the Eiffel Tower?... (k=5)
2025-04-16 19:37:03,682 - graph_rag.api.routers.query - INFO - Query successful. Found 0 chunks.
2025-04-16 19:37:03,683 - graph_rag.api.routers.query - ERROR - Error processing query 'Where is the Eiffel Tower?': not enough values to unpack (expected 2, got 0)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03,683 - graph_rag.api.main - WARNING - HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03,684 - httpx - INFO - HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error"
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=eb395961-c9f4-4a72-a206-68f2e355c8f5 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 7a058ac9-5941-4406-8623-875c38b20cfb] Received ingestion request.
INFO     graph_rag.api.routers.ingestion:ingestion.py:33 Document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 processed successfully.
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_query_pipeline:test_query_pipeline.py:150 Ingested document doc-0737e5a7-10bb-458d-a9f4-92825393a9e8 for query test.
INFO     graph_rag.api.main:main.py:315 rid=0f4287f7-a357-478b-88c9-3e9796383ee9 path=/api/v1/query method=POST
INFO     graph_rag.api.routers.query:query.py:29 Received query: Where is the Eiffel Tower?... (k=5)
INFO     graph_rag.api.routers.query:query.py:33 Query successful. Found 0 chunks.
ERROR    graph_rag.api.routers.query:query.py:64 Error processing query 'Where is the Eiffel Tower?': not enough values to unpack (expected 2, got 0)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
WARNING  graph_rag.api.main:main.py:328 HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0)
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error"
____________________________ test_query_no_entities ____________________________

test_client = <httpx.AsyncClient object at 0x36124ba40>

    @pytest.mark.asyncio
    async def test_query_no_entities(test_client: AsyncClient):
        """Test query handling when no entities are found in the query."""
        query_text = "This is a query with no named entities"
        response = await test_client.post(
            "/api/v1/query",
            json={
                "query_text": query_text,
                "k": 5
            }
        )
    
>       assert response.status_code == status.HTTP_200_OK
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code
E        +  and   200 = status.HTTP_200_OK

tests/integration/test_query_pipeline.py:190: AssertionError
----------------------------- Captured stdout call -----------------------------
2025-04-16 19:37:03,703 - graph_rag.api.main - INFO - rid=e4110218-bacf-48c4-96bc-5ddc2bb6e1cc path=/api/v1/query method=POST
2025-04-16 19:37:03,704 - graph_rag.api.routers.query - INFO - Received query: This is a query with no named entities... (k=5)
2025-04-16 19:37:03,705 - graph_rag.api.routers.query - INFO - Query successful. Found 0 chunks.
2025-04-16 19:37:03,705 - graph_rag.api.routers.query - ERROR - Error processing query 'This is a query with no named entities': not enough values to unpack (expected 2, got 0)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03,705 - graph_rag.api.main - WARNING - HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0)
2025-04-16 19:37:03,706 - httpx - INFO - HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error"
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=e4110218-bacf-48c4-96bc-5ddc2bb6e1cc path=/api/v1/query method=POST
INFO     graph_rag.api.routers.query:query.py:29 Received query: This is a query with no named entities... (k=5)
INFO     graph_rag.api.routers.query:query.py:33 Query successful. Found 0 chunks.
ERROR    graph_rag.api.routers.query:query.py:64 Error processing query 'This is a query with no named entities': not enough values to unpack (expected 2, got 0)
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/query.py", line 49, in execute_query
    domain_entities, domain_relationships = query_result.graph_context
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 0)
WARNING  graph_rag.api.main:main.py:328 HTTP exception for http://test/api/v1/query: 500 - Failed to process query: not enough values to unpack (expected 2, got 0)
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/query "HTTP/1.1 500 Internal Server Error"
=========================== short test summary info ============================
FAILED tests/integration/test_e2e.py::test_ingest_and_keyword_search - NameEr...
FAILED tests/integration/test_e2e.py::test_ingest_and_vector_search - NameErr...
FAILED tests/integration/test_e2e.py::test_search_nonexistent_term - NameErro...
FAILED tests/integration/test_e2e.py::test_ingest_and_delete - assert 404 == 204
FAILED tests/integration/test_ingest_command.py::test_process_and_store_document_cli_logic
FAILED tests/integration/test_ingestion_integration.py::test_document_ingestion_pipeline
FAILED tests/integration/test_ingestion_integration.py::test_concurrent_ingestion_integration
FAILED tests/integration/test_ingestion_integration.py::test_large_document_ingestion_integration
FAILED tests/integration/test_ingestion_integration.py::test_error_handling_integration
FAILED tests/integration/test_query_pipeline.py::test_basic_query - assert 50...
FAILED tests/integration/test_query_pipeline.py::test_query_no_entities - ass...
ERROR tests/integration/test_query_pipeline.py::test_query_pipeline - Failed:...
============== 11 failed, 11 passed, 1 error in 73.20s (0:01:13) ===============
