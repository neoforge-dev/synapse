============================= test session starts ==============================
platform darwin -- Python 3.12.7, pytest-8.3.5, pluggy-1.5.0 -- /Users/bogdan/til/graph-rag-mcp/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/bogdan/til/graph-rag-mcp
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-0.26.0, mock-3.14.0, cov-6.1.1
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 220 items / 1 skipped

pymgclient/test/test_connection.py::test_connect_args_validation PASSED  [  0%]
pymgclient/test/test_connection.py::test_connect_insecure_success SKIPPED [  0%]
pymgclient/test/test_connection.py::test_connection_secure_fail SKIPPED  [  1%]
pymgclient/test/test_connection.py::test_connection_secure_success SKIPPED [  1%]
pymgclient/test/test_connection.py::test_connection_close SKIPPED (M...) [  2%]
pymgclient/test/test_connection.py::test_connection_close_lazy SKIPPED   [  2%]
pymgclient/test/test_connection.py::test_autocommit_regular SKIPPED      [  3%]
pymgclient/test/test_connection.py::test_autocommit_lazy SKIPPED (ME...) [  3%]
pymgclient/test/test_connection.py::test_commit SKIPPED (MEMGRAPH_HO...) [  4%]
pymgclient/test/test_connection.py::test_rollback SKIPPED (MEMGRAPH_...) [  4%]
pymgclient/test/test_connection.py::test_close_doesnt_commit SKIPPED     [  5%]
pymgclient/test/test_connection.py::test_commit_rollback_lazy SKIPPED    [  5%]
pymgclient/test/test_connection.py::test_autocommit_failure SKIPPED      [  5%]
pymgclient/test/test_cursor.py::test_cursor_visibility SKIPPED (MEMG...) [  6%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_execute_closed_connection SKIPPED [  6%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_close SKIPPED [  7%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchone SKIPPED [  7%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchmany SKIPPED [  8%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchall SKIPPED [  8%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_multiple_queries SKIPPED [  9%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_syntax_error SKIPPED [  9%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_runtime_error SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_description SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchone_without_result SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchmany_without_result SKIPPED [ 11%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_result_ref_counts SKIPPED [ 11%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_execute_twice SKIPPED [ 12%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_execute_during_execution SKIPPED [ 12%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_close_during_execution SKIPPED [ 13%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_result_available_after_fetch SKIPPED [ 13%]
pymgclient/test/test_glue.py::test_none SKIPPED (MEMGRAPH_HOST is un...) [ 14%]
pymgclient/test/test_glue.py::test_bool SKIPPED (MEMGRAPH_HOST is un...) [ 14%]
pymgclient/test/test_glue.py::test_integer SKIPPED (MEMGRAPH_HOST is...) [ 15%]
pymgclient/test/test_glue.py::test_float SKIPPED (MEMGRAPH_HOST is u...) [ 15%]
pymgclient/test/test_glue.py::test_string SKIPPED (MEMGRAPH_HOST is ...) [ 15%]
pymgclient/test/test_glue.py::test_list SKIPPED (MEMGRAPH_HOST is un...) [ 16%]
pymgclient/test/test_glue.py::test_map SKIPPED (MEMGRAPH_HOST is uns...) [ 16%]
pymgclient/test/test_glue.py::test_node SKIPPED (MEMGRAPH_HOST is un...) [ 17%]
pymgclient/test/test_glue.py::test_relationship SKIPPED (MEMGRAPH_HO...) [ 17%]
pymgclient/test/test_glue.py::test_path SKIPPED (MEMGRAPH_HOST is un...) [ 18%]
pymgclient/test/test_glue.py::test_tuple SKIPPED (MEMGRAPH_HOST is u...) [ 18%]
pymgclient/test/test_glue.py::test_time SKIPPED (MEMGRAPH_HOST is un...) [ 19%]
pymgclient/test/test_glue.py::test_date SKIPPED (MEMGRAPH_HOST is un...) [ 19%]
pymgclient/test/test_glue.py::test_datetime SKIPPED (MEMGRAPH_HOST i...) [ 20%]
pymgclient/test/test_glue.py::test_duration SKIPPED (MEMGRAPH_HOST i...) [ 20%]
pymgclient/test/test_types.py::test_node PASSED                          [ 20%]
pymgclient/test/test_types.py::test_relationship PASSED                  [ 21%]
pymgclient/test/test_types.py::test_path PASSED                          [ 21%]
tests/api/test_documents.py::test_delete_document_endpoint_success PASSED [ 22%]
tests/api/test_documents.py::test_delete_document_endpoint_not_found PASSED [ 22%]
tests/api/test_documents.py::test_delete_document_endpoint_repository_error PASSED [ 23%]
tests/api/test_documents.py::test_patch_document_metadata_success PASSED [ 23%]
tests/api/test_documents.py::test_patch_document_no_body PASSED          [ 24%]
tests/api/test_documents.py::test_patch_document_invalid_field PASSED    [ 24%]
tests/api/test_documents.py::test_patch_document_not_found PASSED        [ 25%]
tests/api/test_documents.py::test_patch_document_repository_error PASSED [ 25%]
tests/api/test_endpoints.py::test_health_check PASSED                    [ 25%]
tests/api/test_endpoints.py::test_create_document PASSED                 [ 26%]
tests/api/test_endpoints.py::test_get_document PASSED                    [ 26%]
tests/api/test_ingestion.py::test_ingest_document_endpoint PASSED        [ 27%]
tests/api/test_ingestion.py::test_ingest_document_handles_endpoint_error PASSED [ 27%]
tests/api/test_ingestion_api.py::test_ingest_document_empty_content PASSED [ 28%]
tests/api/test_ingestion_api.py::test_ingest_document_missing_content PASSED [ 28%]
tests/api/test_ingestion_api.py::test_ingest_document_invalid_metadata_type PASSED [ 29%]
tests/api/test_ingestion_api.py::test_background_processing_success PASSED [ 29%]
tests/api/test_ingestion_api.py::test_ingest_large_document PASSED       [ 30%]
tests/api/test_ingestion_api.py::test_ingest_document_with_special_chars PASSED [ 30%]
tests/api/test_ingestion_api.py::test_concurrent_ingestion PASSED        [ 30%]
tests/api/test_main_endpoints.py::test_read_root PASSED                  [ 31%]
tests/api/test_main_endpoints.py::test_health_check_main PASSED          [ 31%]
tests/api/test_query_api.py::test_query_success PASSED                   [ 32%]
tests/api/test_query_api.py::test_query_success_with_graph_context PASSED [ 32%]
tests/api/test_query_api.py::test_query_engine_error PASSED              [ 33%]
tests/api/test_query_api.py::test_query_invalid_request_missing_text PASSED [ 33%]
tests/api/test_query_api.py::test_query_invalid_request_bad_k_type PASSED [ 34%]
tests/api/test_query_api.py::test_query_missing_query_text PASSED        [ 34%]
tests/api/test_query_api.py::test_query_no_entities PASSED               [ 35%]
tests/api/test_search.py::test_unified_search_keyword PASSED             [ 35%]
tests/api/test_search.py::test_unified_search_vector PASSED              [ 35%]
tests/api/test_search.py::test_unified_search_engine_error PASSED        [ 36%]
tests/api/test_search.py::test_unified_search_invalid_search_type PASSED [ 36%]
tests/api/test_search.py::test_unified_search_invalid_limit PASSED       [ 37%]
tests/api/test_search_ingestion.py::test_ingest_document_success PASSED  [ 37%]
tests/api/test_search_ingestion.py::test_ingest_document_empty_content PASSED [ 38%]
tests/api/test_search_ingestion.py::test_search_batch_success PASSED     [ 38%]
tests/api/test_search_ingestion.py::test_search_stream_success PASSED    [ 39%]
tests/api/test_search_ingestion.py::test_search_no_results PASSED        [ 39%]
tests/api/test_search_ingestion.py::test_search_invalid_type PASSED      [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_file_success PASSED [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_no_input PASSED     [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_invalid_metadata PASSED [ 41%]
tests/cli/test_cli_commands.py::test_search_batch_success PASSED         [ 41%]
tests/cli/test_cli_commands.py::test_search_stream_success PASSED        [ 42%]
tests/cli/test_cli_commands.py::test_admin_health_success PASSED         [ 42%]
tests/cli/test_cli_commands.py::test_admin_health_unhealthy PASSED       [ 43%]
tests/cli/test_cli_commands.py::test_admin_health_api_error PASSED       [ 43%]
tests/cli/test_cli_ingest.py::test_ingest_file_success PASSED            [ 44%]
tests/cli/test_cli_ingest.py::test_ingest_missing_file_argument PASSED   [ 44%]
tests/cli/test_cli_ingest.py::test_ingest_file_not_found PASSED          [ 45%]
tests/cli/test_cli_ingest.py::test_ingest_invalid_metadata_json SKIPPED  [ 45%]
tests/cli/test_cli_ingest.py::test_cli_large_file_handling PASSED        [ 45%]
tests/cli/test_cli_ingest.py::test_cli_special_chars_handling PASSED     [ 46%]
tests/cli/test_cli_ingest.py::test_ingest_processing_error PASSED        [ 46%]
tests/config/test_settings.py::test_settings_load_defaults PASSED        [ 47%]
tests/config/test_settings.py::test_settings_load_from_env_vars PASSED   [ 47%]
tests/config/test_settings.py::test_settings_memgraph_uri_override_from_env PASSED [ 48%]
tests/config/test_settings.py::test_settings_load_from_env_file PASSED   [ 48%]
tests/config/test_settings.py::test_settings_memgraph_uri_override PASSED [ 49%]
tests/core/test_debug_tools.py::test_capture_system_state SKIPPED (A...) [ 49%]
tests/core/test_debug_tools.py::test_analyze_query_performance SKIPPED   [ 50%]
tests/core/test_debug_tools.py::test_validate_graph_structure SKIPPED    [ 50%]
tests/core/test_debug_tools.py::test_create_debug_context SKIPPED (S...) [ 50%]
tests/core/test_debug_tools.py::test_save_and_load_debug_context SKIPPED [ 51%]
tests/core/test_debug_tools.py::test_capture_system_state_integration SKIPPED [ 51%]
tests/core/test_debug_tools.py::test_analyze_query_performance_integration SKIPPED [ 52%]
tests/core/test_debug_tools.py::test_validate_graph_structure_integration SKIPPED [ 52%]
tests/core/test_document_processor.py::test_sentence_splitter_basic PASSED [ 53%]
tests/core/test_document_processor.py::test_sentence_splitter_empty_doc PASSED [ 53%]
tests/core/test_document_processor.py::test_sentence_splitter_single_sentence PASSED [ 54%]
tests/core/test_document_processor.py::test_sentence_splitter_empty_doc_preserves_metadata PASSED [ 54%]
tests/core/test_document_processor.py::test_sentence_splitter_preserves_metadata PASSED [ 55%]
tests/core/test_document_processor_async.py::test_minimal_async PASSED   [ 55%]
tests/core/test_document_processor_async.py::test_simple_chunking_by_paragraph PASSED [ 55%]
tests/core/test_document_processor_async.py::test_simple_chunking_fixed_tokens PASSED [ 56%]
tests/core/test_document_processor_async.py::test_simple_chunking_invalid_strategy PASSED [ 56%]
tests/core/test_document_processor_async.py::test_simple_chunking_empty_doc PASSED [ 57%]
tests/core/test_document_processor_async.py::test_simple_chunking_whitespace_doc PASSED [ 57%]
tests/core/test_entity_extractor.py::test_spacy_extracts_entities FAILED [ 58%]
tests/core/test_entity_extractor.py::test_spacy_extract_no_entities FAILED [ 58%]
tests/core/test_entity_extractor.py::test_spacy_extract_empty_text PASSED [ 59%]
tests/core/test_entity_extractor.py::test_mock_extractor_finds_entities PASSED [ 59%]
tests/core/test_entity_extractor.py::test_mock_extractor_no_entities PASSED [ 60%]
tests/core/test_entity_extractor.py::test_mock_extractor_empty_document PASSED [ 60%]
tests/core/test_graph_debugging_scenarios.py::test_debug_orphaned_nodes SKIPPED [ 60%]
tests/core/test_graph_debugging_scenarios.py::test_debug_query_performance SKIPPED [ 61%]
tests/core/test_graph_debugging_scenarios.py::test_debug_relationship_patterns SKIPPED [ 61%]
tests/core/test_graph_debugging_scenarios.py::test_debug_transaction_issues SKIPPED [ 62%]
tests/core/test_graph_debugging_scenarios.py::test_debug_index_issues SKIPPED [ 62%]
tests/core/test_graph_rag_engine.py::test_process_and_store_document_flow SKIPPED [ 63%]
tests/core/test_graph_rag_engine.py::test_retrieve_context_vector PASSED [ 63%]
tests/core/test_graph_rag_engine.py::test_simple_engine_query_uses_stores PASSED [ 64%]
tests/core/test_graph_rag_engine.py::test_engine_initialization PASSED   [ 64%]
tests/core/test_graph_rag_engine.py::test_engine_requires_stores PASSED  [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_calls_vector_store SKIPPED [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_no_results SKIPPED [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_handles_vector_store_error SKIPPED [ 66%]
tests/core/test_graph_rag_engine.py::test_engine_query_retrieves_graph_context SKIPPED [ 66%]
tests/core/test_graph_rag_engine.py::test_engine_query_graph_context_disabled SKIPPED [ 67%]
tests/core/test_graph_rag_engine.py::test_engine_query_no_entities_found_in_graph SKIPPED [ 67%]
tests/core/test_knowledge_graph_builder.py::test_add_document PASSED     [ 68%]
tests/core/test_knowledge_graph_builder.py::test_add_chunk PASSED        [ 68%]
tests/core/test_knowledge_graph_builder.py::test_add_entity PASSED       [ 69%]
tests/core/test_knowledge_graph_builder.py::test_add_relationship PASSED [ 69%]
tests/core/test_knowledge_graph_builder.py::test_link_chunk_to_entities PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_add_duplicate_document PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_builder_adds_entities_and_relationships PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_builder_no_data_does_nothing PASSED [ 71%]
tests/core/test_knowledge_graph_builder.py::test_builder_requires_graph_store PASSED [ 71%]
tests/core/test_senior_debug_protocol.py::test_observe_failure PASSED    [ 72%]
tests/core/test_senior_debug_protocol.py::test_analyze_test_case PASSED  [ 72%]
tests/core/test_senior_debug_protocol.py::test_question_assumptions PASSED [ 73%]
tests/core/test_senior_debug_protocol.py::test_trace_execution_path PASSED [ 73%]
tests/core/test_senior_debug_protocol.py::test_identify_implementation_gaps PASSED [ 74%]
tests/core/test_senior_debug_protocol.py::test_create_investigation PASSED [ 74%]
tests/core/test_senior_debug_protocol.py::test_generate_hypotheses PASSED [ 75%]
tests/core/test_senior_debug_protocol.py::test_verify_hypothesis PASSED  [ 75%]
tests/core/test_senior_debug_protocol.py::test_resolve_issue PASSED      [ 75%]
tests/core/test_senior_debug_protocol.py::test_save_and_load_investigation PASSED [ 76%]
tests/core/test_senior_debug_protocol.py::test_handle_persistent_error PASSED [ 76%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_add_get_entity PASSED [ 77%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_document_as_entity PASSED [ 77%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_chunk_as_entity PASSED [ 78%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_entity_interface_operations PASSED [ 78%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_relationship_operations PASSED [ 79%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_bulk_operations PASSED [ 79%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_error_handling PASSED [ 80%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_neighbor_operations PASSED [ 80%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_property_search PASSED [ 80%]
tests/infrastructure/repositories/test_graph_repository.py::test_delete_document PASSED [ 81%]
tests/infrastructure/repositories/test_graph_repository.py::test_delete_nonexistent_document PASSED [ 81%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_metadata PASSED [ 82%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_nonexistent PASSED [ 82%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_no_properties PASSED [ 83%]
tests/integration/test_e2e.py::test_ingest_and_keyword_search FAILED     [ 83%]
tests/integration/test_e2e.py::test_ingest_and_vector_search FAILED      [ 84%]
tests/integration/test_e2e.py::test_search_nonexistent_term FAILED       [ 84%]

=================================== FAILURES ===================================
_________________________ test_spacy_extracts_entities _________________________

self = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x353313860>
document = Document(id='test-doc-1', content='Some text mentioning Apple Inc. in Cupertino with Tim Cook.', metadata={}, chunks=[...ent_id='test-doc-1', metadata={}, embedding=None, created_at=None, updated_at=None)], created_at=None, updated_at=None)

    def extract(self, document: Document) -> ProcessedDocument:
        """Extracts entities from all chunks in a document using spaCy NER.
           Processes chunk by chunk using extract_from_text.
           Relationships are not extracted by this implementation.
        """
        if not self.nlp:
            logger.error(f"spaCy model '{self.model_name}' is not loaded. Cannot extract entities.")
            # Return a ProcessedDocument with empty lists
            return ProcessedDocument(
                id=document.id,
                content=document.content,
                metadata=document.metadata.copy(),
                chunks=document.chunks, # Keep original chunks
                entities=[],
                relationships=[]
            )
    
        all_entities: Dict[str, Entity] = {}
        # The original extract method expected document.chunks, ensure it exists or handle error
        # For robustness, check if document has chunks attribute
        if not hasattr(document, 'chunks') or not document.chunks:
             logger.warning(f"Document {document.id} has no chunks attribute or empty chunks list. Cannot extract entities.")
             return ProcessedDocument(
                 id=document.id,
                 content=document.content,
                 metadata=document.metadata.copy(),
                 chunks=[], # Return empty chunks list
                 entities=[],
                 relationships=[]
             )
    
        logger.info(f"Starting spaCy entity extraction for document {document.id} ({len(document.chunks)} chunks)")
    
        tasks = []
        for i, chunk in enumerate(document.chunks):
            logger.debug(f"Scheduling chunk {i+1}/{len(document.chunks)} (id: {chunk.id}) for entity extraction.")
            if chunk.text and not chunk.text.isspace():
                context = {"chunk_id": chunk.id, "doc_id": document.id}
                tasks.append(self.extract_from_text(chunk.text, context))
    
        # Run extraction tasks concurrently, handling sync/async context
        try:
>           loop = asyncio.get_running_loop()
E           RuntimeError: no running event loop

graph_rag/core/entity_extractor.py:168: RuntimeError

During handling of the above exception, another exception occurred:

mock_spacy_nlp = <MagicMock name='load()' id='14284499104'>

    def test_spacy_extracts_entities(mock_spacy_nlp):
        """Test that entities are extracted correctly using mocked spaCy."""
        # Configure the mock nlp object passed via fixture for *this specific test*
        # Create mock entities
        mock_ent_apple = MagicMock()
        mock_ent_apple.text = "Apple Inc."
        mock_ent_apple.label_ = "ORG"
    
        mock_ent_cupertino = MagicMock()
        mock_ent_cupertino.text = "Cupertino"
        mock_ent_cupertino.label_ = "GPE" # Geo-Political Entity
    
        mock_ent_cook = MagicMock()
        mock_ent_cook.text = "Tim Cook"
        mock_ent_cook.label_ = "PERSON"
    
        # Create a mock Doc object containing these entities
        mock_doc_for_test = MagicMock()
        mock_doc_for_test.ents = [mock_ent_apple, mock_ent_cupertino, mock_ent_cook]
    
        # Set the return value of the mock nlp *instance* for this test
        mock_spacy_nlp.return_value = mock_doc_for_test
    
        # Patch spacy.load directly, as import is local in __init__
        with patch("spacy.load") as mock_spacy_load:
            mock_spacy_load.return_value = mock_spacy_nlp
    
            extractor = SpacyEntityExtractor()
            # The extractor now uses the mocked nlp object during initialization
    
            # Define test text and create a Document object
            test_text = "Some text mentioning Apple Inc. in Cupertino with Tim Cook."
            test_doc = Document(id="test-doc-1", content=test_text, chunks=[Chunk(id="c1", text=test_text, document_id="test-doc-1")])
    
            # Call extract method with Document object
>           extraction_result: ProcessedDocument = extractor.extract(test_doc)

tests/core/test_entity_extractor.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
graph_rag/core/entity_extractor.py:172: in extract
    extraction_results = asyncio.run(asyncio.gather(*tasks))
../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/tasks.py:831: in gather
    fut = ensure_future(arg, loop=loop)
../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/tasks.py:693: in ensure_future
    loop = events.get_event_loop()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.unix_events._UnixDefaultEventLoopPolicy object at 0x3501afc80>

    def get_event_loop(self):
        """Get the event loop for the current context.
    
        Returns an instance of EventLoop or raises an exception.
        """
        if (self._local._loop is None and
                not self._local._set_called and
                threading.current_thread() is threading.main_thread()):
            stacklevel = 2
            try:
                f = sys._getframe(1)
            except AttributeError:
                pass
            else:
                # Move up the call stack so that the warning is attached
                # to the line outside asyncio itself.
                while f:
                    module = f.f_globals.get('__name__')
                    if not (module == 'asyncio' or module.startswith('asyncio.')):
                        break
                    f = f.f_back
                    stacklevel += 1
            import warnings
            warnings.warn('There is no current event loop',
                          DeprecationWarning, stacklevel=stacklevel)
            self.set_event_loop(self.new_event_loop())
    
        if self._local._loop is None:
>           raise RuntimeError('There is no current event loop in thread %r.'
                               % threading.current_thread().name)
E           RuntimeError: There is no current event loop in thread 'MainThread'.

../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/events.py:702: RuntimeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 10:34:54,626 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-17 10:34:54,626 - graph_rag.core.entity_extractor - INFO - Starting spaCy entity extraction for document test-doc-1 (1 chunks)
------------------------------ Captured log call -------------------------------
INFO     graph_rag.core.entity_extractor:entity_extractor.py:75 spaCy model 'en_core_web_sm' loaded successfully.
INFO     graph_rag.core.entity_extractor:entity_extractor.py:157 Starting spaCy entity extraction for document test-doc-1 (1 chunks)
________________________ test_spacy_extract_no_entities ________________________

self = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x35367b080>
document = Document(id='test-doc-2', content='Just some plain text without named entities.', metadata={}, chunks=[Chunk(id='c2', ...ent_id='test-doc-2', metadata={}, embedding=None, created_at=None, updated_at=None)], created_at=None, updated_at=None)

    def extract(self, document: Document) -> ProcessedDocument:
        """Extracts entities from all chunks in a document using spaCy NER.
           Processes chunk by chunk using extract_from_text.
           Relationships are not extracted by this implementation.
        """
        if not self.nlp:
            logger.error(f"spaCy model '{self.model_name}' is not loaded. Cannot extract entities.")
            # Return a ProcessedDocument with empty lists
            return ProcessedDocument(
                id=document.id,
                content=document.content,
                metadata=document.metadata.copy(),
                chunks=document.chunks, # Keep original chunks
                entities=[],
                relationships=[]
            )
    
        all_entities: Dict[str, Entity] = {}
        # The original extract method expected document.chunks, ensure it exists or handle error
        # For robustness, check if document has chunks attribute
        if not hasattr(document, 'chunks') or not document.chunks:
             logger.warning(f"Document {document.id} has no chunks attribute or empty chunks list. Cannot extract entities.")
             return ProcessedDocument(
                 id=document.id,
                 content=document.content,
                 metadata=document.metadata.copy(),
                 chunks=[], # Return empty chunks list
                 entities=[],
                 relationships=[]
             )
    
        logger.info(f"Starting spaCy entity extraction for document {document.id} ({len(document.chunks)} chunks)")
    
        tasks = []
        for i, chunk in enumerate(document.chunks):
            logger.debug(f"Scheduling chunk {i+1}/{len(document.chunks)} (id: {chunk.id}) for entity extraction.")
            if chunk.text and not chunk.text.isspace():
                context = {"chunk_id": chunk.id, "doc_id": document.id}
                tasks.append(self.extract_from_text(chunk.text, context))
    
        # Run extraction tasks concurrently, handling sync/async context
        try:
>           loop = asyncio.get_running_loop()
E           RuntimeError: no running event loop

graph_rag/core/entity_extractor.py:168: RuntimeError

During handling of the above exception, another exception occurred:

mock_spacy_nlp = <MagicMock name='load()' id='14284315232'>

    def test_spacy_extract_no_entities(mock_spacy_nlp):
        """Test extraction when spaCy finds no entities."""
        # Configure the mocked Doc to have no entities
        mock_spacy_doc_no_ents = MagicMock()
        mock_spacy_doc_no_ents.ents = []
        mock_spacy_nlp.return_value = mock_spacy_doc_no_ents
    
        with patch("spacy.load") as mock_spacy_load: # Corrected patch target
            mock_spacy_load.return_value = mock_spacy_nlp
    
            extractor = SpacyEntityExtractor()
            test_text = "Just some plain text without named entities."
            test_doc = Document(id="test-doc-2", content=test_text, chunks=[Chunk(id="c2", text=test_text, document_id="test-doc-2")])
    
>           extraction_result = extractor.extract(test_doc)

tests/core/test_entity_extractor.py:99: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
graph_rag/core/entity_extractor.py:172: in extract
    extraction_results = asyncio.run(asyncio.gather(*tasks))
../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/tasks.py:831: in gather
    fut = ensure_future(arg, loop=loop)
../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/tasks.py:693: in ensure_future
    loop = events.get_event_loop()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <asyncio.unix_events._UnixDefaultEventLoopPolicy object at 0x3501afc80>

    def get_event_loop(self):
        """Get the event loop for the current context.
    
        Returns an instance of EventLoop or raises an exception.
        """
        if (self._local._loop is None and
                not self._local._set_called and
                threading.current_thread() is threading.main_thread()):
            stacklevel = 2
            try:
                f = sys._getframe(1)
            except AttributeError:
                pass
            else:
                # Move up the call stack so that the warning is attached
                # to the line outside asyncio itself.
                while f:
                    module = f.f_globals.get('__name__')
                    if not (module == 'asyncio' or module.startswith('asyncio.')):
                        break
                    f = f.f_back
                    stacklevel += 1
            import warnings
            warnings.warn('There is no current event loop',
                          DeprecationWarning, stacklevel=stacklevel)
            self.set_event_loop(self.new_event_loop())
    
        if self._local._loop is None:
>           raise RuntimeError('There is no current event loop in thread %r.'
                               % threading.current_thread().name)
E           RuntimeError: There is no current event loop in thread 'MainThread'.

../../.pyenv/versions/3.12.7/lib/python3.12/asyncio/events.py:702: RuntimeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 10:34:54,676 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-17 10:34:54,677 - graph_rag.core.entity_extractor - INFO - Starting spaCy entity extraction for document test-doc-2 (1 chunks)
------------------------------ Captured log call -------------------------------
INFO     graph_rag.core.entity_extractor:entity_extractor.py:75 spaCy model 'en_core_web_sm' loaded successfully.
INFO     graph_rag.core.entity_extractor:entity_extractor.py:157 Starting spaCy entity extraction for document test-doc-2 (1 chunks)
________________________ test_ingest_and_keyword_search ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 149, in test_ingest_and_keyword_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x353671fa0>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_keyword_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent keyword search."""
        doc_content = "Integration testing involves blue widgets."
        metadata = {"source": "integration_test", "color": "blue"}
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        assert "document_id" in ingest_result
        assert "status" in ingest_result
        assert "task_id" in ingest_result
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion to process...")
        await asyncio.sleep(15)
    
        # Keyword Search directly using test_client
        search_query = "widgets"
        limit = 5
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": search_query, "limit": limit}
        )

tests/integration/test_e2e.py:149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:297: in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
graph_rag/api/dependencies.py:177: in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve...del='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2', cache_type='memory')
item = 'graph_context_max_tokens'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 10:34:55,009 - graph_rag.api.main - INFO - rid=005f0013-5809-4fb6-93f7-e259cedb50c4 path=/api/v1/ingestion/documents method=POST
2025-04-17 10:34:55,009 - graph_rag.api.dependencies - INFO - Creating DocumentProcessor instance (SimpleDocumentProcessor)
2025-04-17 10:34:55,009 - graph_rag.core.document_processor - INFO - Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
2025-04-17 10:34:55,010 - graph_rag.api.dependencies - INFO - Creating EntityExtractor instance of type: spacy
2025-04-17 10:34:55,250 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-17 10:34:55,250 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
2025-04-17 10:34:55,250 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Loading sentence-transformer model: all-MiniLM-L6-v2
2025-04-17 10:34:55,251 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-17 10:34:55,251 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-17 10:34:57,668 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Sentence-transformer model loaded successfully.
2025-04-17 10:34:57,668 - graph_rag.api.dependencies - INFO - Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
2025-04-17 10:34:57,669 - graph_rag.services.embedding - INFO - Loading embedding model: all-MiniLM-L6-v2
2025-04-17 10:34:57,669 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-17 10:34:57,669 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-17 10:34:59,547 - graph_rag.services.embedding - INFO - Embedding model loaded successfully.
2025-04-17 10:34:59,547 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-17 10:34:59,547 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-17 10:34:59,547 - graph_rag.api.routers.ingestion - INFO - [Req ID: b08d26ac-6a71-4efe-beca-5e88f1c97676] Received ingestion request.
2025-04-17 10:34:59,548 - graph_rag.services.ingestion - INFO - Starting ingestion for document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8 with metadata: {'source': 'integration_test', 'color': 'blue'}
2025-04-17 10:34:59,553 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8
2025-04-17 10:34:59,553 - graph_rag.services.ingestion - INFO - Saved document with ID: doc-0b22a820-050a-40e3-9b3e-85497b8b01a8
2025-04-17 10:34:59,553 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8: object of type 'coroutine' has no len()
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 100, in ingest_document
    logger.info(f"Split document {document_id} into {len(chunk_objects)} chunks.")
                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'coroutine' has no len()
2025-04-17 10:34:59,554 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-17 10:34:59,554 - test_e2e - INFO - Waiting 5 seconds for ingestion to process...
2025-04-17 10:35:14,556 - graph_rag.api.main - INFO - rid=1cc5e9a3-1516-4f6d-b095-1bff45a31b33 path=/api/v1/search/query method=POST
2025-04-17 10:35:14,558 - graph_rag.api.dependencies - WARNING - LLM_TYPE not found in settings. Falling back to MockLLMService.
2025-04-17 10:35:14,558 - graph_rag.api.dependencies - INFO - Creating CacheService instance (type: memory)
2025-04-17 10:35:14,558 - graph_rag.infrastructure.cache.memory_cache - INFO - MemoryCache initialized.
2025-04-17 10:35:14,558 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=005f0013-5809-4fb6-93f7-e259cedb50c4 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.dependencies:dependencies.py:123 Creating DocumentProcessor instance (SimpleDocumentProcessor)
INFO     graph_rag.core.document_processor:document_processor.py:104 Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
INFO     graph_rag.api.dependencies:dependencies.py:133 Creating EntityExtractor instance of type: spacy
INFO     graph_rag.core.entity_extractor:entity_extractor.py:75 spaCy model 'en_core_web_sm' loaded successfully.
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:18 Loading sentence-transformer model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:20 Sentence-transformer model loaded successfully.
INFO     graph_rag.api.dependencies:dependencies.py:229 Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
INFO     graph_rag.services.embedding:embedding.py:27 Loading embedding model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.services.embedding:embedding.py:31 Embedding model loaded successfully.
WARNING  graph_rag.api.dependencies:dependencies.py:314 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:63 [Req ID: b08d26ac-6a71-4efe-beca-5e88f1c97676] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:79 Starting ingestion for document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8 with metadata: {'source': 'integration_test', 'color': 'blue'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:244 Successfully added/updated document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8
INFO     graph_rag.services.ingestion:ingestion.py:93 Saved document with ID: doc-0b22a820-050a-40e3-9b3e-85497b8b01a8
ERROR    graph_rag.api.routers.ingestion:ingestion.py:36 Background processing failed for document doc-0b22a820-050a-40e3-9b3e-85497b8b01a8: object of type 'coroutine' has no len()
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 100, in ingest_document
    logger.info(f"Split document {document_id} into {len(chunk_objects)} chunks.")
                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'coroutine' has no len()
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:143 Waiting 5 seconds for ingestion to process...
INFO     graph_rag.api.main:main.py:315 rid=1cc5e9a3-1516-4f6d-b095-1bff45a31b33 path=/api/v1/search/query method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:104 LLM_TYPE not found in settings. Falling back to MockLLMService.
INFO     graph_rag.api.dependencies:dependencies.py:61 Creating CacheService instance (type: memory)
INFO     graph_rag.infrastructure.cache.memory_cache:memory_cache.py:13 MemoryCache initialized.
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
________________________ test_ingest_and_vector_search _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 189, in test_ingest_and_vector_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x353713e30>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_vector_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent vector similarity search."""
        doc_content = "Semantic search looks for meaning, like finding vehicles when asked about cars."
        metadata = {"source": "integration_test", "topic": "search"}
        query = "automobiles"
        limit = 3
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion and embedding to process...")
        await asyncio.sleep(15)
    
        # Vector Search directly using test_client
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "vector", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:297: in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
graph_rag/api/dependencies.py:177: in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve...del='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2', cache_type='memory')
item = 'graph_context_max_tokens'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 10:35:14,815 - graph_rag.api.main - INFO - rid=8528efee-ed67-4991-9ea1-109840fa8619 path=/api/v1/ingestion/documents method=POST
2025-04-17 10:35:14,816 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-17 10:35:14,817 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-17 10:35:14,817 - graph_rag.api.routers.ingestion - INFO - [Req ID: 95cab435-c8e0-47d8-9b41-4ebacc936db1] Received ingestion request.
2025-04-17 10:35:14,817 - graph_rag.services.ingestion - INFO - Starting ingestion for document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23 with metadata: {'source': 'integration_test', 'topic': 'search'}
2025-04-17 10:35:14,822 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23
2025-04-17 10:35:14,822 - graph_rag.services.ingestion - INFO - Saved document with ID: doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23
2025-04-17 10:35:14,822 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23: object of type 'coroutine' has no len()
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 100, in ingest_document
    logger.info(f"Split document {document_id} into {len(chunk_objects)} chunks.")
                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'coroutine' has no len()
2025-04-17 10:35:14,822 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-17 10:35:14,822 - test_e2e - INFO - Waiting 5 seconds for ingestion and embedding to process...
2025-04-17 10:35:29,824 - graph_rag.api.main - INFO - rid=136fd579-c82b-4592-bef6-03ef1c92d556 path=/api/v1/search/query method=POST
2025-04-17 10:35:29,830 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=8528efee-ed67-4991-9ea1-109840fa8619 path=/api/v1/ingestion/documents method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:314 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:63 [Req ID: 95cab435-c8e0-47d8-9b41-4ebacc936db1] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:79 Starting ingestion for document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23 with metadata: {'source': 'integration_test', 'topic': 'search'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:244 Successfully added/updated document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23
INFO     graph_rag.services.ingestion:ingestion.py:93 Saved document with ID: doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23
ERROR    graph_rag.api.routers.ingestion:ingestion.py:36 Background processing failed for document doc-3efec1db-84c1-4c7a-87a4-ac3da455ec23: object of type 'coroutine' has no len()
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 100, in ingest_document
    logger.info(f"Split document {document_id} into {len(chunk_objects)} chunks.")
                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'coroutine' has no len()
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:185 Waiting 5 seconds for ingestion and embedding to process...
INFO     graph_rag.api.main:main.py:315 rid=136fd579-c82b-4592-bef6-03ef1c92d556 path=/api/v1/search/query method=POST
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
_________________________ test_search_nonexistent_term _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 215, in test_search_nonexistent_term
    |     keyword_response = await e2e_test_client.post(
    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x3537104d0>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_search_nonexistent_term(e2e_test_client: httpx.AsyncClient):
        """Verify searches for unlikely terms return empty results."""
        query = "zzzyyyxxx_nonexistent_term_qwerty"
        limit = 5
    
        # Keyword Search directly using test_client
>       keyword_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
graph_rag/api/dependencies.py:297: in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
graph_rag/api/dependencies.py:177: in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve...del='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2', cache_type='memory')
item = 'graph_context_max_tokens'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 10:35:30,085 - graph_rag.api.main - INFO - rid=6185c475-b917-4fe3-824d-1da48c618525 path=/api/v1/search/query method=POST
2025-04-17 10:35:30,086 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=6185c475-b917-4fe3-824d-1da48c618525 path=/api/v1/search/query method=POST
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'graph_context_max_tokens'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    |     solved = await call(**solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    |     _singletons["graph_rag_engine"] = create_graph_rag_engine(
    |                                       ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    |     graph_context_tokens=settings.graph_context_max_tokens,
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 638, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 297, in get_graph_rag_engine
    _singletons["graph_rag_engine"] = create_graph_rag_engine(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 177, in create_graph_rag_engine
    graph_context_tokens=settings.graph_context_max_tokens,
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'graph_context_max_tokens'
=========================== short test summary info ============================
FAILED tests/core/test_entity_extractor.py::test_spacy_extracts_entities - Ru...
FAILED tests/core/test_entity_extractor.py::test_spacy_extract_no_entities - ...
FAILED tests/integration/test_e2e.py::test_ingest_and_keyword_search - Attrib...
FAILED tests/integration/test_e2e.py::test_ingest_and_vector_search - Attribu...
FAILED tests/integration/test_e2e.py::test_search_nonexistent_term - Attribut...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 5 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
=========== 5 failed, 116 passed, 66 skipped, 40 warnings in 38.33s ============
