============================= test session starts ==============================
platform darwin -- Python 3.12.7, pytest-8.3.5, pluggy-1.5.0 -- /Users/bogdan/til/graph-rag-mcp/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/bogdan/til/graph-rag-mcp
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-0.26.0, mock-3.14.0, cov-6.1.1
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 220 items / 1 skipped

pymgclient/test/test_connection.py::test_connect_args_validation PASSED  [  0%]
pymgclient/test/test_connection.py::test_connect_insecure_success SKIPPED [  0%]
pymgclient/test/test_connection.py::test_connection_secure_fail SKIPPED  [  1%]
pymgclient/test/test_connection.py::test_connection_secure_success SKIPPED [  1%]
pymgclient/test/test_connection.py::test_connection_close SKIPPED (M...) [  2%]
pymgclient/test/test_connection.py::test_connection_close_lazy SKIPPED   [  2%]
pymgclient/test/test_connection.py::test_autocommit_regular SKIPPED      [  3%]
pymgclient/test/test_connection.py::test_autocommit_lazy SKIPPED (ME...) [  3%]
pymgclient/test/test_connection.py::test_commit SKIPPED (MEMGRAPH_HO...) [  4%]
pymgclient/test/test_connection.py::test_rollback SKIPPED (MEMGRAPH_...) [  4%]
pymgclient/test/test_connection.py::test_close_doesnt_commit SKIPPED     [  5%]
pymgclient/test/test_connection.py::test_commit_rollback_lazy SKIPPED    [  5%]
pymgclient/test/test_connection.py::test_autocommit_failure SKIPPED      [  5%]
pymgclient/test/test_cursor.py::test_cursor_visibility SKIPPED (MEMG...) [  6%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_execute_closed_connection SKIPPED [  6%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_close SKIPPED [  7%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchone SKIPPED [  7%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchmany SKIPPED [  8%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchall SKIPPED [  8%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_multiple_queries SKIPPED [  9%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_syntax_error SKIPPED [  9%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_runtime_error SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_description SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchone_without_result SKIPPED [ 10%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_fetchmany_without_result SKIPPED [ 11%]
pymgclient/test/test_cursor.py::TestCursorInRegularConnection::test_cursor_result_ref_counts SKIPPED [ 11%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_execute_twice SKIPPED [ 12%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_execute_during_execution SKIPPED [ 12%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_cant_close_during_execution SKIPPED [ 13%]
pymgclient/test/test_cursor.py::TestCursorInLazyConnection::test_lazy_result_available_after_fetch SKIPPED [ 13%]
pymgclient/test/test_glue.py::test_none SKIPPED (MEMGRAPH_HOST is un...) [ 14%]
pymgclient/test/test_glue.py::test_bool SKIPPED (MEMGRAPH_HOST is un...) [ 14%]
pymgclient/test/test_glue.py::test_integer SKIPPED (MEMGRAPH_HOST is...) [ 15%]
pymgclient/test/test_glue.py::test_float SKIPPED (MEMGRAPH_HOST is u...) [ 15%]
pymgclient/test/test_glue.py::test_string SKIPPED (MEMGRAPH_HOST is ...) [ 15%]
pymgclient/test/test_glue.py::test_list SKIPPED (MEMGRAPH_HOST is un...) [ 16%]
pymgclient/test/test_glue.py::test_map SKIPPED (MEMGRAPH_HOST is uns...) [ 16%]
pymgclient/test/test_glue.py::test_node SKIPPED (MEMGRAPH_HOST is un...) [ 17%]
pymgclient/test/test_glue.py::test_relationship SKIPPED (MEMGRAPH_HO...) [ 17%]
pymgclient/test/test_glue.py::test_path SKIPPED (MEMGRAPH_HOST is un...) [ 18%]
pymgclient/test/test_glue.py::test_tuple SKIPPED (MEMGRAPH_HOST is u...) [ 18%]
pymgclient/test/test_glue.py::test_time SKIPPED (MEMGRAPH_HOST is un...) [ 19%]
pymgclient/test/test_glue.py::test_date SKIPPED (MEMGRAPH_HOST is un...) [ 19%]
pymgclient/test/test_glue.py::test_datetime SKIPPED (MEMGRAPH_HOST i...) [ 20%]
pymgclient/test/test_glue.py::test_duration SKIPPED (MEMGRAPH_HOST i...) [ 20%]
pymgclient/test/test_types.py::test_node PASSED                          [ 20%]
pymgclient/test/test_types.py::test_relationship PASSED                  [ 21%]
pymgclient/test/test_types.py::test_path PASSED                          [ 21%]
tests/api/test_documents.py::test_delete_document_endpoint_success PASSED [ 22%]
tests/api/test_documents.py::test_delete_document_endpoint_not_found PASSED [ 22%]
tests/api/test_documents.py::test_delete_document_endpoint_repository_error PASSED [ 23%]
tests/api/test_documents.py::test_patch_document_metadata_success PASSED [ 23%]
tests/api/test_documents.py::test_patch_document_no_body PASSED          [ 24%]
tests/api/test_documents.py::test_patch_document_invalid_field PASSED    [ 24%]
tests/api/test_documents.py::test_patch_document_not_found PASSED        [ 25%]
tests/api/test_documents.py::test_patch_document_repository_error PASSED [ 25%]
tests/api/test_endpoints.py::test_health_check PASSED                    [ 25%]
tests/api/test_endpoints.py::test_create_document PASSED                 [ 26%]
tests/api/test_endpoints.py::test_get_document PASSED                    [ 26%]
tests/api/test_ingestion.py::test_ingest_document_endpoint PASSED        [ 27%]
tests/api/test_ingestion.py::test_ingest_document_handles_endpoint_error PASSED [ 27%]
tests/api/test_ingestion_api.py::test_ingest_document_empty_content PASSED [ 28%]
tests/api/test_ingestion_api.py::test_ingest_document_missing_content PASSED [ 28%]
tests/api/test_ingestion_api.py::test_ingest_document_invalid_metadata_type PASSED [ 29%]
tests/api/test_ingestion_api.py::test_background_processing_success PASSED [ 29%]
tests/api/test_ingestion_api.py::test_ingest_large_document PASSED       [ 30%]
tests/api/test_ingestion_api.py::test_ingest_document_with_special_chars PASSED [ 30%]
tests/api/test_ingestion_api.py::test_concurrent_ingestion PASSED        [ 30%]
tests/api/test_main_endpoints.py::test_read_root PASSED                  [ 31%]
tests/api/test_main_endpoints.py::test_health_check_main PASSED          [ 31%]
tests/api/test_query_api.py::test_query_success PASSED                   [ 32%]
tests/api/test_query_api.py::test_query_success_with_graph_context PASSED [ 32%]
tests/api/test_query_api.py::test_query_engine_error PASSED              [ 33%]
tests/api/test_query_api.py::test_query_invalid_request_missing_text PASSED [ 33%]
tests/api/test_query_api.py::test_query_invalid_request_bad_k_type PASSED [ 34%]
tests/api/test_query_api.py::test_query_missing_query_text PASSED        [ 34%]
tests/api/test_query_api.py::test_query_no_entities PASSED               [ 35%]
tests/api/test_search.py::test_unified_search_keyword PASSED             [ 35%]
tests/api/test_search.py::test_unified_search_vector PASSED              [ 35%]
tests/api/test_search.py::test_unified_search_engine_error PASSED        [ 36%]
tests/api/test_search.py::test_unified_search_invalid_search_type PASSED [ 36%]
tests/api/test_search.py::test_unified_search_invalid_limit PASSED       [ 37%]
tests/api/test_search_ingestion.py::test_ingest_document_success PASSED  [ 37%]
tests/api/test_search_ingestion.py::test_ingest_document_empty_content PASSED [ 38%]
tests/api/test_search_ingestion.py::test_search_batch_success PASSED     [ 38%]
tests/api/test_search_ingestion.py::test_search_stream_success PASSED    [ 39%]
tests/api/test_search_ingestion.py::test_search_no_results PASSED        [ 39%]
tests/api/test_search_ingestion.py::test_search_invalid_type PASSED      [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_file_success PASSED [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_no_input PASSED     [ 40%]
tests/cli/test_cli_commands.py::test_ingest_document_invalid_metadata PASSED [ 41%]
tests/cli/test_cli_commands.py::test_search_batch_success PASSED         [ 41%]
tests/cli/test_cli_commands.py::test_search_stream_success PASSED        [ 42%]
tests/cli/test_cli_commands.py::test_admin_health_success PASSED         [ 42%]
tests/cli/test_cli_commands.py::test_admin_health_unhealthy PASSED       [ 43%]
tests/cli/test_cli_commands.py::test_admin_health_api_error PASSED       [ 43%]
tests/cli/test_cli_ingest.py::test_ingest_file_success PASSED            [ 44%]
tests/cli/test_cli_ingest.py::test_ingest_missing_file_argument PASSED   [ 44%]
tests/cli/test_cli_ingest.py::test_ingest_file_not_found PASSED          [ 45%]
tests/cli/test_cli_ingest.py::test_ingest_invalid_metadata_json SKIPPED  [ 45%]
tests/cli/test_cli_ingest.py::test_cli_large_file_handling PASSED        [ 45%]
tests/cli/test_cli_ingest.py::test_cli_special_chars_handling PASSED     [ 46%]
tests/cli/test_cli_ingest.py::test_ingest_processing_error PASSED        [ 46%]
tests/config/test_settings.py::test_settings_load_defaults PASSED        [ 47%]
tests/config/test_settings.py::test_settings_load_from_env_vars PASSED   [ 47%]
tests/config/test_settings.py::test_settings_memgraph_uri_override_from_env PASSED [ 48%]
tests/config/test_settings.py::test_settings_load_from_env_file PASSED   [ 48%]
tests/config/test_settings.py::test_settings_memgraph_uri_override PASSED [ 49%]
tests/core/test_debug_tools.py::test_capture_system_state SKIPPED (A...) [ 49%]
tests/core/test_debug_tools.py::test_analyze_query_performance SKIPPED   [ 50%]
tests/core/test_debug_tools.py::test_validate_graph_structure SKIPPED    [ 50%]
tests/core/test_debug_tools.py::test_create_debug_context SKIPPED (S...) [ 50%]
tests/core/test_debug_tools.py::test_save_and_load_debug_context SKIPPED [ 51%]
tests/core/test_debug_tools.py::test_capture_system_state_integration SKIPPED [ 51%]
tests/core/test_debug_tools.py::test_analyze_query_performance_integration SKIPPED [ 52%]
tests/core/test_debug_tools.py::test_validate_graph_structure_integration SKIPPED [ 52%]
tests/core/test_document_processor.py::test_sentence_splitter_basic PASSED [ 53%]
tests/core/test_document_processor.py::test_sentence_splitter_empty_doc PASSED [ 53%]
tests/core/test_document_processor.py::test_sentence_splitter_single_sentence PASSED [ 54%]
tests/core/test_document_processor.py::test_sentence_splitter_empty_doc_preserves_metadata PASSED [ 54%]
tests/core/test_document_processor.py::test_sentence_splitter_preserves_metadata PASSED [ 55%]
tests/core/test_document_processor_async.py::test_minimal_async PASSED   [ 55%]
tests/core/test_document_processor_async.py::test_simple_chunking_by_paragraph PASSED [ 55%]
tests/core/test_document_processor_async.py::test_simple_chunking_fixed_tokens PASSED [ 56%]
tests/core/test_document_processor_async.py::test_simple_chunking_invalid_strategy PASSED [ 56%]
tests/core/test_document_processor_async.py::test_simple_chunking_empty_doc PASSED [ 57%]
tests/core/test_document_processor_async.py::test_simple_chunking_whitespace_doc PASSED [ 57%]
tests/core/test_entity_extractor.py::test_spacy_extracts_entities PASSED [ 58%]
tests/core/test_entity_extractor.py::test_spacy_extract_no_entities PASSED [ 58%]
tests/core/test_entity_extractor.py::test_spacy_extract_empty_text PASSED [ 59%]
tests/core/test_entity_extractor.py::test_mock_extractor_finds_entities PASSED [ 59%]
tests/core/test_entity_extractor.py::test_mock_extractor_no_entities PASSED [ 60%]
tests/core/test_entity_extractor.py::test_mock_extractor_empty_document PASSED [ 60%]
tests/core/test_graph_debugging_scenarios.py::test_debug_orphaned_nodes SKIPPED [ 60%]
tests/core/test_graph_debugging_scenarios.py::test_debug_query_performance SKIPPED [ 61%]
tests/core/test_graph_debugging_scenarios.py::test_debug_relationship_patterns SKIPPED [ 61%]
tests/core/test_graph_debugging_scenarios.py::test_debug_transaction_issues SKIPPED [ 62%]
tests/core/test_graph_debugging_scenarios.py::test_debug_index_issues SKIPPED [ 62%]
tests/core/test_graph_rag_engine.py::test_process_and_store_document_flow SKIPPED [ 63%]
tests/core/test_graph_rag_engine.py::test_retrieve_context_vector PASSED [ 63%]
tests/core/test_graph_rag_engine.py::test_simple_engine_query_uses_stores PASSED [ 64%]
tests/core/test_graph_rag_engine.py::test_engine_initialization PASSED   [ 64%]
tests/core/test_graph_rag_engine.py::test_engine_requires_stores PASSED  [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_calls_vector_store SKIPPED [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_no_results SKIPPED [ 65%]
tests/core/test_graph_rag_engine.py::test_engine_query_handles_vector_store_error SKIPPED [ 66%]
tests/core/test_graph_rag_engine.py::test_engine_query_retrieves_graph_context SKIPPED [ 66%]
tests/core/test_graph_rag_engine.py::test_engine_query_graph_context_disabled SKIPPED [ 67%]
tests/core/test_graph_rag_engine.py::test_engine_query_no_entities_found_in_graph SKIPPED [ 67%]
tests/core/test_knowledge_graph_builder.py::test_add_document PASSED     [ 68%]
tests/core/test_knowledge_graph_builder.py::test_add_chunk PASSED        [ 68%]
tests/core/test_knowledge_graph_builder.py::test_add_entity PASSED       [ 69%]
tests/core/test_knowledge_graph_builder.py::test_add_relationship PASSED [ 69%]
tests/core/test_knowledge_graph_builder.py::test_link_chunk_to_entities PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_add_duplicate_document PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_builder_adds_entities_and_relationships PASSED [ 70%]
tests/core/test_knowledge_graph_builder.py::test_builder_no_data_does_nothing PASSED [ 71%]
tests/core/test_knowledge_graph_builder.py::test_builder_requires_graph_store PASSED [ 71%]
tests/core/test_senior_debug_protocol.py::test_observe_failure PASSED    [ 72%]
tests/core/test_senior_debug_protocol.py::test_analyze_test_case PASSED  [ 72%]
tests/core/test_senior_debug_protocol.py::test_question_assumptions PASSED [ 73%]
tests/core/test_senior_debug_protocol.py::test_trace_execution_path PASSED [ 73%]
tests/core/test_senior_debug_protocol.py::test_identify_implementation_gaps PASSED [ 74%]
tests/core/test_senior_debug_protocol.py::test_create_investigation PASSED [ 74%]
tests/core/test_senior_debug_protocol.py::test_generate_hypotheses PASSED [ 75%]
tests/core/test_senior_debug_protocol.py::test_verify_hypothesis PASSED  [ 75%]
tests/core/test_senior_debug_protocol.py::test_resolve_issue PASSED      [ 75%]
tests/core/test_senior_debug_protocol.py::test_save_and_load_investigation PASSED [ 76%]
tests/core/test_senior_debug_protocol.py::test_handle_persistent_error PASSED [ 76%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_add_get_entity PASSED [ 77%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_document_as_entity PASSED [ 77%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_chunk_as_entity PASSED [ 78%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_entity_interface_operations PASSED [ 78%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_relationship_operations PASSED [ 79%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_bulk_operations PASSED [ 79%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_error_handling PASSED [ 80%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_neighbor_operations PASSED [ 80%]
tests/infrastructure/graph_stores/test_memgraph_store.py::test_property_search PASSED [ 80%]
tests/infrastructure/repositories/test_graph_repository.py::test_delete_document PASSED [ 81%]
tests/infrastructure/repositories/test_graph_repository.py::test_delete_nonexistent_document PASSED [ 81%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_metadata PASSED [ 82%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_nonexistent PASSED [ 82%]
tests/infrastructure/repositories/test_graph_repository.py::test_update_document_no_properties PASSED [ 83%]
tests/integration/test_e2e.py::test_ingest_and_keyword_search FAILED     [ 83%]
tests/integration/test_e2e.py::test_ingest_and_vector_search FAILED      [ 84%]
tests/integration/test_e2e.py::test_search_nonexistent_term FAILED       [ 84%]
tests/integration/test_e2e.py::test_ingest_and_delete FAILED             [ 85%]
tests/integration/test_e2e.py::test_delete_nonexistent PASSED            [ 85%]
tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_document_operations PASSED [ 85%]
tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_entity_operations PASSED [ 86%]
tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_bulk_operations PASSED [ 86%]
tests/integration/test_graph_store_integration.py::TestMemgraphGraphRepositoryIntegration::test_error_handling PASSED [ 87%]
tests/integration/test_ingest_command.py::test_process_and_store_document_cli_logic FAILED [ 87%]

=================================== FAILURES ===================================
________________________ test_ingest_and_keyword_search ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 149, in test_ingest_and_keyword_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x349c7a570>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_keyword_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent keyword search."""
        doc_content = "Integration testing involves blue widgets."
        metadata = {"source": "integration_test", "color": "blue"}
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        assert "document_id" in ingest_result
        assert "status" in ingest_result
        assert "task_id" in ingest_result
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion to process...")
        await asyncio.sleep(15)
    
        # Keyword Search directly using test_client
        search_query = "widgets"
        limit = 5
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": search_query, "limit": limit}
        )

tests/integration/test_e2e.py:149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:640: in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
.venv/lib/python3.12/site-packages/starlette/concurrency.py:37: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
.venv/lib/python3.12/site-packages/anyio/to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:967: in run
    result = context.run(func, *args)
graph_rag/api/dependencies.py:61: in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')
item = 'cache_type'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'cache_type'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 00:00:41,056 - graph_rag.api.main - INFO - rid=4a2a7880-fa5c-4b3b-981c-0b8100d369f8 path=/api/v1/ingestion/documents method=POST
2025-04-17 00:00:41,057 - graph_rag.api.dependencies - INFO - Creating DocumentProcessor instance (SimpleDocumentProcessor)
2025-04-17 00:00:41,057 - graph_rag.core.document_processor - INFO - Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
2025-04-17 00:00:41,057 - graph_rag.api.dependencies - INFO - Creating EntityExtractor instance of type: spacy
2025-04-17 00:00:41,293 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-17 00:00:41,293 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
2025-04-17 00:00:41,293 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Loading sentence-transformer model: all-MiniLM-L6-v2
2025-04-17 00:00:41,293 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-17 00:00:41,293 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-17 00:00:43,121 - graph_rag.infrastructure.vector_stores.simple_vector_store - INFO - Sentence-transformer model loaded successfully.
2025-04-17 00:00:43,122 - graph_rag.api.dependencies - INFO - Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
2025-04-17 00:00:43,122 - graph_rag.services.embedding - INFO - Loading embedding model: all-MiniLM-L6-v2
2025-04-17 00:00:43,123 - sentence_transformers.SentenceTransformer - INFO - Use pytorch device_name: mps
2025-04-17 00:00:43,123 - sentence_transformers.SentenceTransformer - INFO - Load pretrained SentenceTransformer: all-MiniLM-L6-v2
2025-04-17 00:00:44,765 - graph_rag.services.embedding - INFO - Embedding model loaded successfully.
2025-04-17 00:00:44,766 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-17 00:00:44,766 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-17 00:00:44,766 - graph_rag.api.routers.ingestion - INFO - [Req ID: 8a7ed628-9c91-4872-bc7a-79710ef53fe2] Received ingestion request.
2025-04-17 00:00:44,766 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test', 'color': 'blue'}
2025-04-17 00:00:44,770 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node 99791b3f-9e1c-4943-aa12-8c184c15d542 with type Document
2025-04-17 00:00:44,770 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-17 00:00:44,771 - graph_rag.core.document_processor - INFO - Split document 99791b3f-9e1c-4943-aa12-8c184c15d542 into 1 sentence chunks.
2025-04-17 00:00:44,771 - graph_rag.services.ingestion - INFO - Document 99791b3f-9e1c-4943-aa12-8c184c15d542 split into 1 chunks.
2025-04-17 00:00:44,771 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-17 00:00:44,771 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: abd73026-cf19-433e-a1cc-a22ef5f5c0e0, Embedding is None: True
2025-04-17 00:00:44,771 - graph_rag.services.ingestion - ERROR - Failed to save chunk abd73026-cf19-433e-a1cc-a22ef5f5c0e0 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-17 00:00:44,772 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-17 00:00:44,772 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-3c604805-51d9-49d3-a160-9a32c6a77de4: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-17 00:00:44,773 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-17 00:00:44,773 - test_e2e - INFO - Waiting 5 seconds for ingestion to process...
2025-04-17 00:00:59,775 - graph_rag.api.main - INFO - rid=6f4a1ff9-6328-4eb8-a583-28b709545dec path=/api/v1/search/query method=POST
2025-04-17 00:00:59,776 - graph_rag.api.dependencies - WARNING - LLM_TYPE not found in settings. Falling back to MockLLMService.
2025-04-17 00:00:59,776 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=4a2a7880-fa5c-4b3b-981c-0b8100d369f8 path=/api/v1/ingestion/documents method=POST
INFO     graph_rag.api.dependencies:dependencies.py:123 Creating DocumentProcessor instance (SimpleDocumentProcessor)
INFO     graph_rag.core.document_processor:document_processor.py:104 Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
INFO     graph_rag.api.dependencies:dependencies.py:133 Creating EntityExtractor instance of type: spacy
INFO     graph_rag.core.entity_extractor:entity_extractor.py:74 spaCy model 'en_core_web_sm' loaded successfully.
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:18 Loading sentence-transformer model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.infrastructure.vector_stores.simple_vector_store:simple_vector_store.py:20 Sentence-transformer model loaded successfully.
INFO     graph_rag.api.dependencies:dependencies.py:229 Creating EmbeddingService instance (SentenceTransformerEmbeddingService)
INFO     graph_rag.services.embedding:embedding.py:27 Loading embedding model: all-MiniLM-L6-v2
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:211 Use pytorch device_name: mps
INFO     sentence_transformers.SentenceTransformer:SentenceTransformer.py:219 Load pretrained SentenceTransformer: all-MiniLM-L6-v2
INFO     graph_rag.services.embedding:embedding.py:31 Embedding model loaded successfully.
WARNING  graph_rag.api.dependencies:dependencies.py:314 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: 8a7ed628-9c91-4872-bc7a-79710ef53fe2] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test', 'color': 'blue'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node 99791b3f-9e1c-4943-aa12-8c184c15d542 with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document 99791b3f-9e1c-4943-aa12-8c184c15d542 into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document 99791b3f-9e1c-4943-aa12-8c184c15d542 split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk abd73026-cf19-433e-a1cc-a22ef5f5c0e0 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-3c604805-51d9-49d3-a160-9a32c6a77de4: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:143 Waiting 5 seconds for ingestion to process...
INFO     graph_rag.api.main:main.py:315 rid=6f4a1ff9-6328-4eb8-a583-28b709545dec path=/api/v1/search/query method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:104 LLM_TYPE not found in settings. Falling back to MockLLMService.
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
________________________ test_ingest_and_vector_search _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 189, in test_ingest_and_vector_search
    |     search_response = await e2e_test_client.post(
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x34be363f0>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_vector_search(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent vector similarity search."""
        doc_content = "Semantic search looks for meaning, like finding vehicles when asked about cars."
        metadata = {"source": "integration_test", "topic": "search"}
        query = "automobiles"
        limit = 3
    
        # Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": True}
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        doc_id = ingest_result["document_id"]
    
        # Add delay to allow async ingestion to complete
        logger.info("Waiting 5 seconds for ingestion and embedding to process...")
        await asyncio.sleep(15)
    
        # Vector Search directly using test_client
>       search_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "vector", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:640: in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
.venv/lib/python3.12/site-packages/starlette/concurrency.py:37: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
.venv/lib/python3.12/site-packages/anyio/to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:967: in run
    result = context.run(func, *args)
graph_rag/api/dependencies.py:61: in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')
item = 'cache_type'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'cache_type'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 00:01:00,097 - graph_rag.api.main - INFO - rid=9fa0297b-241b-463f-b051-328f9a8ce757 path=/api/v1/ingestion/documents method=POST
2025-04-17 00:01:00,098 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-17 00:01:00,098 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-17 00:01:00,098 - graph_rag.api.routers.ingestion - INFO - [Req ID: fd3fb730-5ce2-46c6-be21-05ee57c049d1] Received ingestion request.
2025-04-17 00:01:00,098 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test', 'topic': 'search'}
2025-04-17 00:01:00,104 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node c960d1c9-3658-4211-8396-0f1bab81c8e0 with type Document
2025-04-17 00:01:00,104 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-17 00:01:00,104 - graph_rag.core.document_processor - INFO - Split document c960d1c9-3658-4211-8396-0f1bab81c8e0 into 1 sentence chunks.
2025-04-17 00:01:00,104 - graph_rag.services.ingestion - INFO - Document c960d1c9-3658-4211-8396-0f1bab81c8e0 split into 1 chunks.
2025-04-17 00:01:00,104 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-17 00:01:00,104 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: 30613af5-b49e-4ae7-8778-acabb8260519, Embedding is None: True
2025-04-17 00:01:00,105 - graph_rag.services.ingestion - ERROR - Failed to save chunk 30613af5-b49e-4ae7-8778-acabb8260519 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-17 00:01:00,105 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-17 00:01:00,105 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-d6e4dda3-86de-47a0-9a7e-c1430321f2ae: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-17 00:01:00,105 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-17 00:01:00,105 - test_e2e - INFO - Waiting 5 seconds for ingestion and embedding to process...
2025-04-17 00:01:15,107 - graph_rag.api.main - INFO - rid=a88775b0-3339-4ab9-912b-bd323c60e330 path=/api/v1/search/query method=POST
2025-04-17 00:01:15,109 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=9fa0297b-241b-463f-b051-328f9a8ce757 path=/api/v1/ingestion/documents method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:314 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: fd3fb730-5ce2-46c6-be21-05ee57c049d1] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test', 'topic': 'search'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node c960d1c9-3658-4211-8396-0f1bab81c8e0 with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document c960d1c9-3658-4211-8396-0f1bab81c8e0 into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document c960d1c9-3658-4211-8396-0f1bab81c8e0 split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk 30613af5-b49e-4ae7-8778-acabb8260519 or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-d6e4dda3-86de-47a0-9a7e-c1430321f2ae: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     test_e2e:test_e2e.py:185 Waiting 5 seconds for ingestion and embedding to process...
INFO     graph_rag.api.main:main.py:315 rid=a88775b0-3339-4ab9-912b-bd323c60e330 path=/api/v1/search/query method=POST
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
_________________________ test_search_nonexistent_term _________________________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 898, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    |     teardown.throw(exception)  # type: ignore[union-attr]
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 549, in runtest
    |     super().runtest()
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 1069, in inner
    |     _loop.run_until_complete(task)
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/tests/integration/test_e2e.py", line 215, in test_search_nonexistent_term
    |     keyword_response = await e2e_test_client.post(
    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

e2e_test_client = <httpx.AsyncClient object at 0x348fcd130>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_search_nonexistent_term(e2e_test_client: httpx.AsyncClient):
        """Verify searches for unlikely terms return empty results."""
        query = "zzzyyyxxx_nonexistent_term_qwerty"
        limit = 5
    
        # Keyword Search directly using test_client
>       keyword_response = await e2e_test_client.post(
            f"{BASE_URL}/search/query",
            json={"search_type": "keyword", "query": query, "limit": limit}
        )

tests/integration/test_e2e.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:173: in __call__
    with recv_stream, send_stream, collapse_excgroups():
../../.pyenv/versions/3.12.7/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:82: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:175: in __call__
    response = await self.dispatch_func(request, call_next)
graph_rag/api/main.py:316: in add_request_id
    response = await call_next(request)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:153: in call_next
    raise app_exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:140: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:73: in app
    response = await f(request)
.venv/lib/python3.12/site-packages/fastapi/routing.py:291: in app
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py:640: in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
.venv/lib/python3.12/site-packages/starlette/concurrency.py:37: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
.venv/lib/python3.12/site-packages/anyio/to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:967: in run
    result = context.run(func, *args)
graph_rag/api/dependencies.py:61: in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = Settings(APP_NAME='graph-rag-mcp', APP_VERSION='0.1.0', DEBUG=False, api_host='localhost', api_port=8000, api_log_leve..., entity_extractor_model='en_core_web_sm', vector_store_type='simple', vector_store_embedding_model='all-MiniLM-L6-v2')
item = 'cache_type'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'cache_type'

.venv/lib/python3.12/site-packages/pydantic/main.py:994: AttributeError
----------------------------- Captured stdout call -----------------------------
2025-04-17 00:01:15,364 - graph_rag.api.main - INFO - rid=7865eda6-fd44-45cb-a7e2-bed303943dd9 path=/api/v1/search/query method=POST
2025-04-17 00:01:15,365 - graph_rag.api.main - ERROR - Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=7865eda6-fd44-45cb-a7e2-bed303943dd9 path=/api/v1/search/query method=POST
ERROR    graph_rag.api.main:main.py:323 Unhandled exception for request http://localhost:8000/api/v1/search/query: 'Settings' object has no attribute 'cache_type'
  + Exception Group Traceback (most recent call last):
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 174, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    |     raise app_exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    |     solved_result = await solve_dependencies(
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    |     solved = await run_in_threadpool(call, **solved_result.values)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    |     logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
    |                                                          ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    |     raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
    | AttributeError: 'Settings' object has no attribute 'cache_type'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 173, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/.pyenv/versions/3.12.7/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 175, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/main.py", line 316, in add_request_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 153, in call_next
    raise app_exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 140, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 291, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 615, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 640, in solve_dependencies
    solved = await run_in_threadpool(call, **solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 967, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/dependencies.py", line 61, in get_cache_service
    logger.info(f"Creating CacheService instance (type: {settings.cache_type})")
                                                         ^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 994, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
AttributeError: 'Settings' object has no attribute 'cache_type'
____________________________ test_ingest_and_delete ____________________________

e2e_test_client = <httpx.AsyncClient object at 0x349379790>

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_ingest_and_delete(e2e_test_client: httpx.AsyncClient):
        """Verify ingestion and subsequent deletion."""
        doc_content = "This document is created solely for deletion testing."
        metadata = {"source": "integration_test_delete"}
    
        # 1. Ingest directly using test_client
        ingest_response = await e2e_test_client.post(
            f"{BASE_URL}/ingestion/documents",
            json={"content": doc_content, "metadata": metadata, "generate_embeddings": False} # No embedding needed
        )
        if ingest_response.status_code != status.HTTP_202_ACCEPTED:
            print(f"Ingest response status: {ingest_response.status_code}, body: {ingest_response.text}")
        assert ingest_response.status_code == status.HTTP_202_ACCEPTED
        ingest_result = ingest_response.json()
        assert "document_id" in ingest_result
        assert "status" in ingest_result
        assert "task_id" in ingest_result
        doc_id = ingest_result["document_id"]
    
        # 2. Verify existence (optional - depends on having a GET /document/{id} endpoint)
        # get_response = await test_client.get(f"{BASE_URL}/documents/{doc_id}")
        # assert get_response.status_code == status.HTTP_200_OK
    
        # 3. Delete directly using test_client
        delete_response = await e2e_test_client.delete(f"{BASE_URL}/documents/{doc_id}")
        if delete_response.status_code != status.HTTP_204_NO_CONTENT:
            print(f"Delete response status: {delete_response.status_code}, body: {delete_response.text}")
>       assert delete_response.status_code == status.HTTP_204_NO_CONTENT
E       assert 404 == 204
E        +  where 404 = <Response [404 Not Found]>.status_code
E        +  and   204 = status.HTTP_204_NO_CONTENT

tests/integration/test_e2e.py:267: AssertionError
----------------------------- Captured stdout call -----------------------------
2025-04-17 00:01:15,622 - graph_rag.api.main - INFO - rid=edbcdc14-7ffa-4280-8d9a-245e9d029c68 path=/api/v1/ingestion/documents method=POST
2025-04-17 00:01:15,623 - graph_rag.api.dependencies - WARNING - Ingestion service not found in app state, creating new instance.
2025-04-17 00:01:15,623 - graph_rag.services.ingestion - INFO - IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
2025-04-17 00:01:15,623 - graph_rag.api.routers.ingestion - INFO - [Req ID: c3d380dc-c600-4d1e-88e7-6158735edc16] Received ingestion request.
2025-04-17 00:01:15,624 - graph_rag.services.ingestion - INFO - Starting ingestion for document with metadata: {'source': 'integration_test_delete'}
2025-04-17 00:01:15,630 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - Successfully added/updated node c5da2855-5859-4a0c-9fa1-79f08f72512c with type Document
2025-04-17 00:01:15,630 - graph_rag.services.ingestion - INFO - Saved document with ID: None
2025-04-17 00:01:15,630 - graph_rag.core.document_processor - INFO - Split document c5da2855-5859-4a0c-9fa1-79f08f72512c into 1 sentence chunks.
2025-04-17 00:01:15,630 - graph_rag.services.ingestion - INFO - Document c5da2855-5859-4a0c-9fa1-79f08f72512c split into 1 chunks.
2025-04-17 00:01:15,630 - graph_rag.services.ingestion - INFO - Split document None into 1 chunks.
2025-04-17 00:01:15,630 - graph_rag.services.ingestion - ERROR - Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
DEBUG: Before save_chunk - Chunk ID: 69a02ed0-a9a1-4e24-9b8f-d1f4f46ce01a, Embedding is None: True
2025-04-17 00:01:15,630 - graph_rag.services.ingestion - ERROR - Failed to save chunk 69a02ed0-a9a1-4e24-9b8f-d1f4f46ce01a or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
2025-04-17 00:01:15,631 - graph_rag.services.ingestion - INFO - Ingestion complete for document None. Saved 0 chunks.
2025-04-17 00:01:15,631 - graph_rag.api.routers.ingestion - ERROR - Background processing failed for document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-04-17 00:01:15,631 - httpx - INFO - HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
2025-04-17 00:01:15,631 - graph_rag.api.main - INFO - rid=211417bc-46d7-411f-a86b-e57a7eeb70b1 path=/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc method=DELETE
2025-04-17 00:01:15,632 - graph_rag.api.routers.documents - INFO - Attempting to delete document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc and its chunks.
2025-04-17 00:01:15,636 - graph_rag.infrastructure.graph_stores.memgraph_store - WARNING - Document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found, nothing deleted (deleted flag false).
2025-04-17 00:01:15,636 - graph_rag.api.routers.documents - WARNING - Document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found for deletion.
2025-04-17 00:01:15,636 - graph_rag.api.main - WARNING - HTTP exception for http://localhost:8000/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc: 404 - Document with id doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found or could not be deleted.
2025-04-17 00:01:15,637 - httpx - INFO - HTTP Request: DELETE http://localhost:8000/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc "HTTP/1.1 404 Not Found"
Delete response status: 404, body: {"detail":"Document with id doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found or could not be deleted."}
------------------------------ Captured log call -------------------------------
INFO     graph_rag.api.main:main.py:315 rid=edbcdc14-7ffa-4280-8d9a-245e9d029c68 path=/api/v1/ingestion/documents method=POST
WARNING  graph_rag.api.dependencies:dependencies.py:314 Ingestion service not found in app state, creating new instance.
INFO     graph_rag.services.ingestion:ingestion.py:53 IngestionService initialized with processor: SimpleDocumentProcessor,             extractor: SpacyEntityExtractor, store: MemgraphGraphRepository
INFO     graph_rag.api.routers.ingestion:ingestion.py:62 [Req ID: c3d380dc-c600-4d1e-88e7-6158735edc16] Received ingestion request.
INFO     graph_rag.services.ingestion:ingestion.py:77 Starting ingestion for document with metadata: {'source': 'integration_test_delete'}
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:360 Successfully added/updated node c5da2855-5859-4a0c-9fa1-79f08f72512c with type Document
INFO     graph_rag.services.ingestion:ingestion.py:86 Saved document with ID: None
INFO     graph_rag.core.document_processor:document_processor.py:86 Split document c5da2855-5859-4a0c-9fa1-79f08f72512c into 1 sentence chunks.
INFO     graph_rag.services.ingestion:ingestion.py:163 Document c5da2855-5859-4a0c-9fa1-79f08f72512c split into 1 chunks.
INFO     graph_rag.services.ingestion:ingestion.py:93 Split document None into 1 chunks.
ERROR    graph_rag.services.ingestion:ingestion.py:115 Failed to generate embeddings for document None: 'Chunk' object has no attribute 'content'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 98, in ingest_document
    chunk_texts = [chunk.content for chunk in chunk_objects]
                   ^^^^^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'content'
ERROR    graph_rag.services.ingestion:ingestion.py:147 Failed to save chunk 69a02ed0-a9a1-4e24-9b8f-d1f4f46ce01a or its relationship for document None: 'Chunk' object has no attribute 'type'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 135, in ingest_document
    chunk_id = await self.graph_store.add_entity(chunk)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 914, in add_entity
    await self.add_node(entity)
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/infrastructure/graph_stores/memgraph_store.py", line 331, in add_node
    logger.debug(f"Adding/updating node {node.id} ({node.type})")
                                                    ^^^^^^^^^
AttributeError: 'Chunk' object has no attribute 'type'
INFO     graph_rag.services.ingestion:ingestion.py:151 Ingestion complete for document None. Saved 0 chunks.
ERROR    graph_rag.api.routers.ingestion:ingestion.py:35 Background processing failed for document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/api/routers/ingestion.py", line 28, in process_document_with_service
    await ingestion_service.ingest_document(
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/services/ingestion.py", line 153, in ingest_document
    return IngestionResult(
           ^^^^^^^^^^^^^^^^
  File "/Users/bogdan/til/graph-rag-mcp/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for IngestionResult
document_id
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
INFO     httpx:_client.py:1740 HTTP Request: POST http://localhost:8000/api/v1/ingestion/documents "HTTP/1.1 202 Accepted"
INFO     graph_rag.api.main:main.py:315 rid=211417bc-46d7-411f-a86b-e57a7eeb70b1 path=/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc method=DELETE
INFO     graph_rag.api.routers.documents:documents.py:126 Attempting to delete document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc and its chunks.
WARNING  graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:947 Document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found, nothing deleted (deleted flag false).
WARNING  graph_rag.api.routers.documents:documents.py:130 Document doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found for deletion.
WARNING  graph_rag.api.main:main.py:328 HTTP exception for http://localhost:8000/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc: 404 - Document with id doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc not found or could not be deleted.
INFO     httpx:_client.py:1740 HTTP Request: DELETE http://localhost:8000/api/v1/documents/doc-d6bc229b-ee2a-4a8d-98c4-1567a95c1bfc "HTTP/1.1 404 Not Found"
__________________ test_process_and_store_document_cli_logic ___________________

file_path = PosixPath('/var/folders/h4/rhh6b9dd7779n60jjvzcpx580000gn/T/tmpqoi8syvy.txt')
metadata_dict = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
graph_repository = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x34921f620>
doc_processor = <graph_rag.core.document_processor.SimpleDocumentProcessor object at 0x34921fb90>
entity_extractor = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x348f1cdd0>

    async def process_and_store_document(
        file_path: Path,
        metadata_dict: Dict[str, Any],
        graph_repository: MemgraphRepository,
        doc_processor: SimpleDocumentProcessor,
        entity_extractor: SpacyEntityExtractor
    ) -> None:
        """Process a document and store it in the graph database."""
        try:
            # Read document content
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
    
            # Generate document ID
            doc_id = str(uuid.uuid4())
    
            # Process document into chunks
>           chunks = await doc_processor.process_document(content)
E           AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'

graph_rag/cli/commands/ingest.py:76: AttributeError

During handling of the above exception, another exception occurred:

test_document = '\n    The Eiffel Tower is a wrought-iron lattice tower in Paris, France.\n    It was designed by Gustave Eiffel and completed in 1889.\n    The tower is 330 meters tall and is the most-visited paid monument in the world.\n    '
test_metadata = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x34921f620>

    @pytest.mark.asyncio
    async def test_process_and_store_document_cli_logic( # Rename test for clarity
        test_document: str,
        test_metadata: Dict[str, Any],
        memgraph_repo: MemgraphGraphRepository # Use the fixture from conftest
    ):
        """Test the core document processing and storage logic from the CLI command."""
        doc_content_for_query = test_document # Store for assertion query
    
        # Create a temporary file with the test document content
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", encoding='utf-8', delete=False) as f:
            f.write(test_document)
            file_path = Path(f.name)
    
        # Define a query to find the document later based on unique metadata
        find_doc_query = "MATCH (d:Document {source: $source}) RETURN d.id as id, d.content as content, d.metadata as metadata LIMIT 1"
        find_doc_params = {"source": test_metadata["source"]}
    
        try:
            # Initialize components needed by the function
            doc_processor = SimpleDocumentProcessor(chunk_strategy="paragraph")
            entity_extractor = SpacyEntityExtractor() # Assumes model is downloaded/available
    
            # Call the CLI processing function directly
>           await process_and_store_document(
                file_path=file_path,
                metadata_dict=test_metadata,
                graph_repository=memgraph_repo, # Pass the correct repo instance
                doc_processor=doc_processor,
                entity_extractor=entity_extractor
                # No kg_builder needed here
            )

tests/integration/test_ingest_command.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

file_path = PosixPath('/var/folders/h4/rhh6b9dd7779n60jjvzcpx580000gn/T/tmpqoi8syvy.txt')
metadata_dict = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
graph_repository = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x34921f620>
doc_processor = <graph_rag.core.document_processor.SimpleDocumentProcessor object at 0x34921fb90>
entity_extractor = <graph_rag.core.entity_extractor.SpacyEntityExtractor object at 0x348f1cdd0>

    async def process_and_store_document(
        file_path: Path,
        metadata_dict: Dict[str, Any],
        graph_repository: MemgraphRepository,
        doc_processor: SimpleDocumentProcessor,
        entity_extractor: SpacyEntityExtractor
    ) -> None:
        """Process a document and store it in the graph database."""
        try:
            # Read document content
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
    
            # Generate document ID
            doc_id = str(uuid.uuid4())
    
            # Process document into chunks
            chunks = await doc_processor.process_document(content)
    
            # Store document
            await graph_repository.add_document({
                "id": doc_id,
                "content": content,
                "metadata": metadata_dict
            })
    
            # Process and store each chunk
            for chunk in chunks:
                # Generate chunk ID
                chunk_id = str(uuid.uuid4())
    
                # Extract entities from chunk
                entities = await entity_extractor.extract_entities(chunk.text)
    
                # Store chunk
                await graph_repository.add_chunk({
                    "id": chunk_id,
                    "text": chunk.text,
                    "document_id": doc_id,
                    "embedding": None  # TODO: Add embedding support
                })
    
                # Store entities and create relationships
                entity_ids = []
                for entity in entities:
                    entity_id = str(uuid.uuid4())
                    await graph_repository.add_entity({
                        "id": entity_id,
                        "label": entity.label,
                        "text": entity.text
                    })
                    entity_ids.append(entity_id)
    
                # Link chunk to entities
                if entity_ids:
                    await graph_repository.link_chunk_to_entities(chunk_id, entity_ids)
    
            typer.echo(f"Successfully ingested document {doc_id}")
    
        except Exception as e:
            logger.error(f"Error processing document: {str(e)}", exc_info=True)
            typer.echo(f"Error processing document: {str(e)}", err=True)
>           raise typer.Exit(1)
E           click.exceptions.Exit: 1

graph_rag/cli/commands/ingest.py:121: Exit

During handling of the above exception, another exception occurred:

test_document = '\n    The Eiffel Tower is a wrought-iron lattice tower in Paris, France.\n    It was designed by Gustave Eiffel and completed in 1889.\n    The tower is 330 meters tall and is the most-visited paid monument in the world.\n    '
test_metadata = {'language': 'en', 'source': 'test-cli-ingest', 'type': 'factual'}
memgraph_repo = <graph_rag.infrastructure.graph_stores.memgraph_store.MemgraphGraphRepository object at 0x34921f620>

    @pytest.mark.asyncio
    async def test_process_and_store_document_cli_logic( # Rename test for clarity
        test_document: str,
        test_metadata: Dict[str, Any],
        memgraph_repo: MemgraphGraphRepository # Use the fixture from conftest
    ):
        """Test the core document processing and storage logic from the CLI command."""
        doc_content_for_query = test_document # Store for assertion query
    
        # Create a temporary file with the test document content
        with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", encoding='utf-8', delete=False) as f:
            f.write(test_document)
            file_path = Path(f.name)
    
        # Define a query to find the document later based on unique metadata
        find_doc_query = "MATCH (d:Document {source: $source}) RETURN d.id as id, d.content as content, d.metadata as metadata LIMIT 1"
        find_doc_params = {"source": test_metadata["source"]}
    
        try:
            # Initialize components needed by the function
            doc_processor = SimpleDocumentProcessor(chunk_strategy="paragraph")
            entity_extractor = SpacyEntityExtractor() # Assumes model is downloaded/available
    
            # Call the CLI processing function directly
            await process_and_store_document(
                file_path=file_path,
                metadata_dict=test_metadata,
                graph_repository=memgraph_repo, # Pass the correct repo instance
                doc_processor=doc_processor,
                entity_extractor=entity_extractor
                # No kg_builder needed here
            )
    
            # Verify document was stored by querying metadata/content
            # Allow some time for potential async writes if necessary, though await should handle it
            await asyncio.sleep(0.1)
            result = await memgraph_repo._execute_read_query(find_doc_query, find_doc_params)
    
            assert result is not None and len(result) == 1, f"Document with source '{test_metadata['source']}' not found."
            stored_doc_data = result[0]
            doc_id = stored_doc_data["id"] # Get the generated ID for further checks
    
            assert stored_doc_data["content"] == doc_content_for_query
            assert stored_doc_data["metadata"] == test_metadata
    
            # Verify chunks were created and linked (Requires get_chunks_by_document_id or direct query)
            # Example direct query:
            chunk_check_query = "MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk) RETURN count(c) as count"
            chunk_result = await memgraph_repo._execute_read_query(chunk_check_query, {"doc_id": doc_id})
            assert chunk_result[0]["count"] > 0, "No chunks found linked to the document."
    
            # Verify entities were extracted and linked
            entity_check_query = """
            MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk)<-[:MENTIONED_IN]-(e:Entity)
            RETURN DISTINCT e.name as name
            """
            # Note: process_and_store_document stores entity 'text', not 'name'. Adjust query/code.
            # Assuming entity node has 'text' property based on process_and_store_document code:
            entity_check_query_alt = """
            MATCH (d:Document {id: $doc_id})-[:CONTAINS]->(c:Chunk)-[:MENTIONS]->(e:Entity)
            RETURN DISTINCT e.text as name
            """ # Relationship is :MENTIONS based on process_and_store_document
            result_entities = await memgraph_repo._execute_read_query(entity_check_query_alt, {"doc_id": doc_id})
    
            extracted_entities = {r["name"] for r in result_entities}
            logger.info(f"Extracted entities for doc {doc_id}: {extracted_entities}")
            assert len(extracted_entities) > 0
            assert "Eiffel Tower" in extracted_entities
            assert "Paris" in extracted_entities
            assert "Gustave Eiffel" in extracted_entities
    
        finally:
            # Clean up the temporary file
            if file_path.exists():
                file_path.unlink()
    
            # Clean up the graph using the retrieved doc_id if found
            if 'doc_id' in locals() and doc_id:
                 await memgraph_repo._execute_write_query("MATCH (d:Document {id: $doc_id}) DETACH DELETE d", {"doc_id": doc_id})
            else: # Fallback cleanup based on metadata if doc_id wasn't retrieved
>                await memgraph_repo._execute_write_query("MATCH (d:Document {source: $source}) DETACH DELETE d", find_doc_params)
E                AttributeError: 'MemgraphGraphRepository' object has no attribute '_execute_write_query'

tests/integration/test_ingest_command.py:133: AttributeError
---------------------------- Captured stdout setup -----------------------------
2025-04-17 00:01:16,040 - graph_rag.infrastructure.graph_stores.memgraph_store - INFO - MemgraphGraphRepository initialized for localhost:7687
------------------------------ Captured log setup ------------------------------
INFO     graph_rag.infrastructure.graph_stores.memgraph_store:memgraph_store.py:81 MemgraphGraphRepository initialized for localhost:7687
----------------------------- Captured stdout call -----------------------------
2025-04-17 00:01:16,042 - graph_rag.core.document_processor - INFO - Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
2025-04-17 00:01:16,281 - graph_rag.core.entity_extractor - INFO - spaCy model 'en_core_web_sm' loaded successfully.
2025-04-17 00:01:16,282 - graph_rag.cli.commands.ingest - ERROR - Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/cli/commands/ingest.py", line 76, in process_and_store_document
    chunks = await doc_processor.process_document(content)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'
----------------------------- Captured stderr call -----------------------------
Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
------------------------------ Captured log call -------------------------------
INFO     graph_rag.core.document_processor:document_processor.py:104 Initialized SimpleDocumentProcessor with strategy: paragraph, tokens_per_chunk: 200
INFO     graph_rag.core.entity_extractor:entity_extractor.py:74 spaCy model 'en_core_web_sm' loaded successfully.
ERROR    graph_rag.cli.commands.ingest:ingest.py:119 Error processing document: 'SimpleDocumentProcessor' object has no attribute 'process_document'
Traceback (most recent call last):
  File "/Users/bogdan/til/graph-rag-mcp/graph_rag/cli/commands/ingest.py", line 76, in process_and_store_document
    chunks = await doc_processor.process_document(content)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'SimpleDocumentProcessor' object has no attribute 'process_document'
=========================== short test summary info ============================
FAILED tests/integration/test_e2e.py::test_ingest_and_keyword_search - Attrib...
FAILED tests/integration/test_e2e.py::test_ingest_and_vector_search - Attribu...
FAILED tests/integration/test_e2e.py::test_search_nonexistent_term - Attribut...
FAILED tests/integration/test_e2e.py::test_ingest_and_delete - assert 404 == 204
FAILED tests/integration/test_ingest_command.py::test_process_and_store_document_cli_logic
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 5 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
=========== 5 failed, 123 passed, 66 skipped, 39 warnings in 37.94s ============
