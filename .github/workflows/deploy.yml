name: Deploy to Staging and Production

on:
  push:
    branches:
      - develop  # Deploy to staging
      - main     # Deploy to production
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.11'

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      deploy: ${{ steps.determine-env.outputs.deploy }}

    steps:
    - name: Determine environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.event_name }}" = "release" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT
        else
          echo "environment=none" >> $GITHUB_OUTPUT
          echo "deploy=false" >> $GITHUB_OUTPUT
        fi

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.sha }}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

  test:
    name: Run Tests Before Deploy
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.deploy == 'true'

    services:
      memgraph:
        image: memgraph/memgraph:latest
        ports:
          - 7687:7687
        options: --health-cmd "echo 'SELECT 1;' | mgconsole" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-deploy-${{ hashFiles('pyproject.toml') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,all]"

    - name: Wait for Memgraph
      run: |
        timeout 60s bash -c 'until nc -z localhost 7687; do sleep 1; done'

    - name: Run critical tests
      run: |
        pytest tests/ -v --tb=short -m "not slow"
      env:
        MEMGRAPH_URI: bolt://localhost:7687
        PYTHONPATH: .

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: needs.prepare.outputs.deploy == 'true'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=${{ needs.prepare.outputs.environment }}
          type=raw,value=latest,enable=${{ needs.prepare.outputs.environment == 'production' }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
        build-args: |
          VERSION=${{ needs.prepare.outputs.version }}
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    if: needs.prepare.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.synapse.neoforge.dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to staging (Railway)
      run: |
        echo "Deploying to Railway staging environment"
        # Add Railway deployment command here
        # Example: railway up --service synapse-staging --environment staging
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Wait for deployment
      run: sleep 30

    - name: Run health check
      run: |
        max_attempts=10
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if curl -f https://staging.synapse.neoforge.dev/health; then
            echo "Health check passed"
            exit 0
          fi
          attempt=$((attempt + 1))
          echo "Health check failed, attempt $attempt/$max_attempts"
          sleep 10
        done
        echo "Health check failed after $max_attempts attempts"
        exit 1

    - name: Run smoke tests
      run: |
        curl -f https://staging.synapse.neoforge.dev/docs
        echo "Smoke tests passed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    if: needs.prepare.outputs.environment == 'production'
    environment:
      name: production
      url: https://synapse.neoforge.dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to production (Railway)
      run: |
        echo "Deploying to Railway production environment"
        # Add Railway deployment command here
        # Example: railway up --service synapse-prod --environment production
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Wait for deployment
      run: sleep 45

    - name: Run health check
      run: |
        max_attempts=15
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if curl -f https://synapse.neoforge.dev/health; then
            echo "Health check passed"
            exit 0
          fi
          attempt=$((attempt + 1))
          echo "Health check failed, attempt $attempt/$max_attempts"
          sleep 10
        done
        echo "Health check failed after $max_attempts attempts"
        exit 1

    - name: Run smoke tests
      run: |
        curl -f https://synapse.neoforge.dev/docs
        curl -f https://synapse.neoforge.dev/api/v1/health
        echo "Smoke tests passed"

    - name: Notify deployment success
      if: success()
      run: |
        echo "✅ Production deployment successful"
        echo "Version: ${{ needs.prepare.outputs.version }}"
        echo "URL: https://synapse.neoforge.dev"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Rollback deployment
      run: |
        ENV=${{ needs.prepare.outputs.environment }}
        echo "Rolling back $ENV deployment"
        # Add rollback commands here
        # Example: railway rollback --service synapse-$ENV --environment $ENV
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Notify rollback
      run: |
        echo "❌ Deployment failed and was rolled back"
        echo "Environment: ${{ needs.prepare.outputs.environment }}"
