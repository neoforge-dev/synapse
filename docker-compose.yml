version: "3.8"

services:
  graph-rag:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      MEMGRAPH_URI: ${MEMGRAPH_URI:-bolt://memgraph:7687}
      MEMGRAPH_USERNAME: ${MEMGRAPH_USERNAME:-}
      MEMGRAPH_PASSWORD: ${MEMGRAPH_PASSWORD:-}
      MEMGRAPH_MAX_POOL_SIZE: ${MEMGRAPH_MAX_POOL_SIZE:-50}
      MEMGRAPH_CONNECTION_TIMEOUT: ${MEMGRAPH_CONNECTION_TIMEOUT:-10}
      MEMGRAPH_RETRY_ATTEMPTS: ${MEMGRAPH_RETRY_ATTEMPTS:-3}
      MEMGRAPH_RETRY_WAIT_SECONDS: ${MEMGRAPH_RETRY_WAIT_SECONDS:-1}
      EMBEDDING_MODEL_NAME: ${EMBEDDING_MODEL_NAME:-all-MiniLM-L6-v2}
      VECTOR_SEARCH_SIMILARITY_THRESHOLD: ${VECTOR_SEARCH_SIMILARITY_THRESHOLD:-0.7}
      DEBUG: ${DEBUG:-False}
    depends_on:
      - memgraph
    volumes:
      - .:/app
    networks:
      - graph-network

  memgraph:
    image: memgraph/memgraph:latest
    ports:
      - "7687:7687"
      - "7444:7444"
    command: --bolt-port=7687 --log-level=TRACE
    networks:
      - graph-network

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-synapse}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-synapse_password}
      POSTGRES_DB: ${POSTGRES_DB:-synapse_business_core}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - graph-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  graph-network:
    driver: bridge

volumes:
  memgraph_data:
    driver: local
  memgraph_logs:
    driver: local
  postgres_data:
    driver: local
